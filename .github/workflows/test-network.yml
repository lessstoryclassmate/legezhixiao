name: Test Network Detection

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '18'

jobs:
  test-network:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        cache-dependency-path: '**/package-lock.json'
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
        # å‰ç«¯ä¾èµ–
        cd frontend && npm ci
        cd ..
        
        # åç«¯ä¾èµ–  
        cd backend && npm ci
        cd ..
        
    - name: Build Docker images
      run: |
        echo "ğŸ”¨ æ„å»ºDockeré•œåƒ..."
        docker-compose build --no-cache
        
    - name: Test network detection script
      run: |
        echo "ğŸ” æµ‹è¯•æ™ºèƒ½ç½‘ç»œæ£€æµ‹è„šæœ¬..."
        
        # ç¡®ä¿è„šæœ¬å¯æ‰§è¡Œ
        chmod +x scripts/detect-network.sh
        
        echo "=== åŸå§‹ç¯å¢ƒä¿¡æ¯ ==="
        echo "å½“å‰ç›®å½•: $PWD"
        echo "ç›®å½•å: $(basename $PWD)"
        echo "å·¥ä½œç©ºé—´: $GITHUB_WORKSPACE"
        
        echo "=== åˆ›å»ºæµ‹è¯•ç½‘ç»œ ==="
        # å¯åŠ¨æœåŠ¡ä»¥åˆ›å»ºç½‘ç»œ
        docker-compose up -d --no-deps mongodb redis
        sleep 10
        
        echo "=== å½“å‰ç½‘ç»œçŠ¶æ€ ==="
        docker network ls
        
        echo "=== æ‰§è¡Œæ™ºèƒ½ç½‘ç»œæ£€æµ‹ ==="
        if bash scripts/detect-network.sh; then
          echo "âœ… ç½‘ç»œæ£€æµ‹æˆåŠŸ"
          
          # æ˜¾ç¤ºæ£€æµ‹ç»“æœ
          if [ -f /tmp/detected_network.env ]; then
            echo "=== æ£€æµ‹ç»“æœ ==="
            cat /tmp/detected_network.env
            
            # åŠ è½½å¹¶éªŒè¯
            source /tmp/detected_network.env
            echo "æ£€æµ‹åˆ°çš„ç½‘ç»œå: $DETECTED_NETWORK_NAME"
            
            # éªŒè¯ç½‘ç»œæ˜¯å¦çœŸå®å­˜åœ¨
            if docker network inspect "$DETECTED_NETWORK_NAME" >/dev/null 2>&1; then
              echo "âœ… æ£€æµ‹åˆ°çš„ç½‘ç»œç¡®å®å­˜åœ¨"
              
              # æ˜¾ç¤ºç½‘ç»œè¯¦æƒ…
              echo "=== ç½‘ç»œè¯¦æƒ… ==="
              docker network inspect "$DETECTED_NETWORK_NAME" | jq '.[0] | {Name, Driver, Scope, Containers}' 2>/dev/null || docker network inspect "$DETECTED_NETWORK_NAME" | head -20
            else
              echo "âŒ æ£€æµ‹åˆ°çš„ç½‘ç»œä¸å­˜åœ¨"
              exit 1
            fi
          else
            echo "âŒ æœªç”Ÿæˆæ£€æµ‹ç»“æœæ–‡ä»¶"
            exit 1
          fi
        else
          echo "âŒ ç½‘ç»œæ£€æµ‹å¤±è´¥"
          echo "=== è°ƒè¯•ä¿¡æ¯ ==="
          bash scripts/detect-network.sh || true
          exit 1
        fi
        
    - name: Test services with detected network
      run: |
        echo "ğŸš€ ä½¿ç”¨æ£€æµ‹åˆ°çš„ç½‘ç»œæµ‹è¯•æœåŠ¡..."
        
        # åŠ è½½ç½‘ç»œæ£€æµ‹ç»“æœ
        if [ -f /tmp/detected_network.env ]; then
          source /tmp/detected_network.env
          echo "ä½¿ç”¨ç½‘ç»œ: $DETECTED_NETWORK_NAME"
        else
          echo "âŒ ç½‘ç»œæ£€æµ‹ç»“æœä¸å¯ç”¨"
          exit 1
        fi
        
        # å¯åŠ¨å®Œæ•´æœåŠ¡æ ˆ
        echo "ğŸš€ å¯åŠ¨å®Œæ•´åº”ç”¨æ ˆ..."
        docker-compose up -d
        
        echo "â³ ç­‰å¾…æœåŠ¡å°±ç»ª..."
        sleep 30
        
        echo "=== æœåŠ¡çŠ¶æ€æ£€æŸ¥ ==="
        docker-compose ps
        
        echo "=== å¥åº·æ£€æŸ¥ ==="
        # æ£€æŸ¥ MongoDB
        if docker-compose exec -T mongodb mongosh --eval "db.adminCommand('ping')" 2>/dev/null; then
          echo "âœ… MongoDB å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ MongoDB å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        # æ£€æŸ¥ Redis
        if docker-compose exec -T redis redis-cli ping 2>/dev/null; then
          echo "âœ… Redis å¥åº·æ£€æŸ¥é€šè¿‡"
        else
          echo "âŒ Redis å¥åº·æ£€æŸ¥å¤±è´¥"
        fi
        
        echo "=== ç½‘ç»œè¿é€šæ€§æµ‹è¯• ==="
        # æµ‹è¯•å®¹å™¨é—´ç½‘ç»œé€šä¿¡
        echo "ğŸ” æµ‹è¯•å®¹å™¨é—´ç½‘ç»œé€šä¿¡..."
        
        # ä»åç«¯å®¹å™¨æµ‹è¯•åˆ° MongoDB
        if docker-compose exec -T backend nslookup mongodb 2>/dev/null; then
          echo "âœ… åç«¯å¯ä»¥è§£æ MongoDB æœåŠ¡å"
        else
          echo "âŒ åç«¯æ— æ³•è§£æ MongoDB æœåŠ¡å"
        fi
        
        # ä»åç«¯å®¹å™¨æµ‹è¯•åˆ° Redis
        if docker-compose exec -T backend nslookup redis 2>/dev/null; then
          echo "âœ… åç«¯å¯ä»¥è§£æ Redis æœåŠ¡å"
        else
          echo "âŒ åç«¯æ— æ³•è§£æ Redis æœåŠ¡å"
        fi
        
        # æµ‹è¯•ç½‘ç»œè¿æ¥è¯¦æƒ…
        echo "=== å®¹å™¨ç½‘ç»œè¯¦æƒ… ==="
        docker network inspect "$DETECTED_NETWORK_NAME" | jq '.[0] | {Name, Containers}' 2>/dev/null || docker network inspect "$DETECTED_NETWORK_NAME" | grep -A 20 '"Containers"'
        
    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ æ¸…ç†æµ‹è¯•ç¯å¢ƒ..."
        docker-compose down -v --remove-orphans || true
        docker system prune -f || true
