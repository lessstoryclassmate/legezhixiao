# GitHub Actions å·¥ä½œæµç¨‹ä¼˜åŒ–ç‰ˆæœ¬

name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # æ„å»ºæµ‹è¯•
  build:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install docker-compose
      run: sudo apt-get update && sudo apt-get install -y docker-compose
      
    - name: Build Docker images
      run: |
        docker-compose build --no-cache
        
    - name: Test Docker containers
      run: |
        # å¯åŠ¨æœåŠ¡è¿›è¡Œæµ‹è¯•
        echo "ğŸš€ å¯åŠ¨DockeræœåŠ¡..."
        docker-compose up -d
        
        # ç­‰å¾…å®¹å™¨å¯åŠ¨
        echo "â³ ç­‰å¾…å®¹å™¨å¯åŠ¨å’Œåˆå§‹åŒ–..."
        sleep 30
        
        # æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥æ‰€æœ‰å®¹å™¨çŠ¶æ€..."
        docker-compose ps
        
        # æ£€æŸ¥æ¯ä¸ªå®¹å™¨çš„å¯åŠ¨çŠ¶æ€
        echo "ğŸ“Š æ£€æŸ¥å„ä¸ªå®¹å™¨çš„è¯¦ç»†çŠ¶æ€..."
        for service in backend frontend mongodb redis; do
          echo "--- æ£€æŸ¥ $service æœåŠ¡ ---"
          docker-compose ps $service
          
          # æ£€æŸ¥å®¹å™¨æ˜¯å¦åœ¨è¿è¡Œ
          if docker-compose ps $service | grep -q "Up"; then
            echo "âœ… $service å®¹å™¨æ­£åœ¨è¿è¡Œ"
          else
            echo "âŒ $service å®¹å™¨æœªæ­£å¸¸è¿è¡Œ"
            echo "ğŸ“‹ $service å®¹å™¨æ—¥å¿—:"
            docker-compose logs $service
          fi
        done
        
        # ç­‰å¾…åç«¯åº”ç”¨å®Œå…¨å¯åŠ¨
        echo "â³ ç­‰å¾…åç«¯åº”ç”¨å®Œå…¨å¯åŠ¨..."
        sleep 30
        
        # æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥ç«¯å£ç›‘å¬çŠ¶æ€..."
        echo "--- æ£€æŸ¥ç«¯å£8000 (åç«¯) ---"
        netstat -tlnp | grep :8000 || echo "âŒ ç«¯å£8000æœªç›‘å¬"
        
        echo "--- æ£€æŸ¥ç«¯å£27017 (MongoDB) ---"
        netstat -tlnp | grep :27017 || echo "âŒ ç«¯å£27017æœªç›‘å¬"
        
        echo "--- æ£€æŸ¥ç«¯å£6379 (Redis) ---"
        netstat -tlnp | grep :6379 || echo "âŒ ç«¯å£6379æœªç›‘å¬"
        
        # è¾“å‡ºåç«¯å®¹å™¨è¯¦ç»†æ—¥å¿—
        echo "ğŸ“‹ åç«¯å®¹å™¨è¯¦ç»†æ—¥å¿—:"
        docker-compose logs backend
        
        # æ£€æŸ¥åç«¯å®¹å™¨å†…çš„è¿›ç¨‹
        echo "ğŸ” æ£€æŸ¥åç«¯å®¹å™¨å†…çš„è¿›ç¨‹..."
        docker-compose exec -T backend ps aux || echo "æ— æ³•æ£€æŸ¥åç«¯å®¹å™¨è¿›ç¨‹"
        
        # æ£€æŸ¥åç«¯å®¹å™¨å†…çš„ç½‘ç»œç›‘å¬
        echo "ğŸ” æ£€æŸ¥åç«¯å®¹å™¨å†…çš„ç½‘ç»œç›‘å¬..."
        docker-compose exec -T backend netstat -tlnp || echo "æ— æ³•æ£€æŸ¥åç«¯å®¹å™¨ç½‘ç»œ"
        
        # å°è¯•ç›´æ¥è¿æ¥åˆ°åç«¯å®¹å™¨
        echo "ğŸ”— å°è¯•ç›´æ¥è¿æ¥åˆ°åç«¯å®¹å™¨..."
        docker-compose exec -T backend curl -f http://localhost:8000/health || echo "æ— æ³•è¿æ¥åˆ°åç«¯å®¹å™¨å†…éƒ¨"
        
        # å¤šæ¬¡å°è¯•å¥åº·æ£€æŸ¥
        echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        for i in {1..5}; do
          echo "å°è¯•ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥..."
          if curl -f http://localhost:8000/health; then
            echo "âœ… å¥åº·æ£€æŸ¥æˆåŠŸ"
            break
          else
            echo "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…10ç§’åé‡è¯•..."
            sleep 10
          fi
          
          if [ $i -eq 5 ]; then
            echo "âŒ å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥ï¼Œè¾“å‡ºæ‰€æœ‰å®¹å™¨æ—¥å¿—..."
            docker-compose logs
            exit 1
          fi
        done
        
        # åœæ­¢æµ‹è¯•å®¹å™¨
        echo "ğŸ›‘ åœæ­¢æµ‹è¯•å®¹å™¨..."
        docker-compose down

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: [quality-check, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        
    - name: Check server connectivity
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} 'echo "Server connected successfully"'
        
    - name: Deploy to production server
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
        MYSQL_USER: ${{ secrets.MYSQL_USER }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²AIå°è¯´ç¼–è¾‘å™¨..."
          
          # è®¾ç½®éƒ¨ç½²ç›®å½•
          PROJECT_DIR="${{ env.DEPLOY_DIR }}"
          BACKUP_DIR="/opt/backups/ai-novel-editor-$(date +%Y%m%d_%H%M%S)"
          
          # åˆ›å»ºç›®å½•
          sudo mkdir -p "$PROJECT_DIR"
          sudo mkdir -p "$(dirname "$BACKUP_DIR")"
          sudo chown $USER:$USER "$PROJECT_DIR"
          sudo chown $USER:$USER "$(dirname "$BACKUP_DIR")"
          
          # å¤‡ä»½ç°æœ‰éƒ¨ç½²
          if [ -d "$PROJECT_DIR/.git" ]; then
            echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            cp -r "$PROJECT_DIR" "$BACKUP_DIR"
            echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
          fi
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd "$PROJECT_DIR"
          
          # å…‹éš†æˆ–æ›´æ–°ä»£ç 
          if [ -d ".git" ]; then
            echo "ğŸ“¦ æ›´æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            echo "ğŸ“¦ å…‹éš†ä»£ç ..."
            git clone ${{ github.server_url }}/${{ github.repository }}.git .
          fi
          
          # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
          echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
          cat > .env << EOF
          # åº”ç”¨é…ç½®
          APP_NAME=AIå°è¯´å†…å®¹ç¼–è¾‘å™¨
          APP_VERSION=1.0.0
          DEBUG=false
          
          # APIé…ç½®
          SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY }}
          SILICONFLOW_API_URL=https://api.siliconflow.cn/v1
          SILICONFLOW_MODEL=deepseek-v3
          
          # JWTé…ç½®
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM=HS256
          JWT_EXPIRE_MINUTES=10080
          
          # æ•°æ®åº“é…ç½®
          MONGODB_URL=mongodb://admin:${{ secrets.MONGO_PASSWORD }}@mongodb:27017/ai_novel_db?authSource=admin
          REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379
          MYSQL_HOST=${{ secrets.MYSQL_HOST }}
          MYSQL_PORT=3306
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE=ai_novel_cloud
          
          # å¯†ç é…ç½®
          MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # CORSé…ç½®
          CORS_ORIGINS=http://${{ secrets.DEPLOY_HOST }}:80,https://${{ secrets.DEPLOY_HOST }}
          EOF
          
          # è®¾ç½®è„šæœ¬æƒé™
          chmod +x scripts/*.sh
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
          docker-compose down || true
          
          # æ¸…ç†Dockerç¼“å­˜
          echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
          docker system prune -f || true
          
          # æ„å»ºå’Œå¯åŠ¨æœåŠ¡
          echo "ğŸ”§ æ„å»ºå’Œå¯åŠ¨æœåŠ¡..."
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        '
        
    - name: Wait for services to start
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
    - name: Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.DEPLOY_HOST }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f --max-time 30 http://${{ secrets.DEPLOY_HOST }}:8000/health; then
          echo "âœ… åç«¯APIæ­£å¸¸"
        else
          echo "âŒ åç«¯APIå¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥APIæ–‡æ¡£
        if curl -f --max-time 30 http://${{ secrets.DEPLOY_HOST }}:8000/docs; then
          echo "âœ… APIæ–‡æ¡£æ­£å¸¸"
        else
          echo "âš ï¸ APIæ–‡æ¡£å¯èƒ½å¼‚å¸¸"
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.DEPLOY_HOST }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.DEPLOY_HOST }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.DEPLOY_HOST }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
        fi
        
    - name: Rollback on failure
      if: failure()
      run: |
        echo "ğŸ”„ éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
          cd ${{ env.DEPLOY_DIR }}
          
          # æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
          LATEST_BACKUP=$(ls -t /opt/backups/ai-novel-editor-* 2>/dev/null | head -1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "ğŸ“¦ å›æ»šåˆ°å¤‡ä»½: $LATEST_BACKUP"
            
            # åœæ­¢å½“å‰æœåŠ¡
            docker-compose down || true
            
            # æ¢å¤å¤‡ä»½
            cp -r "$LATEST_BACKUP"/* .
            
            # é‡å¯æœåŠ¡
            docker-compose up -d
            
            echo "âœ… å›æ»šå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
          fi
        '

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    needs: [quality-check, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
    - name: Deploy to development
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        # è¿™é‡Œå¯ä»¥é…ç½®å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²é€»è¾‘
        echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
