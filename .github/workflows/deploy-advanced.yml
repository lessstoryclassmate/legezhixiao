name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        echo "ğŸ“¦ å‡†å¤‡å®‰è£…å‰ç«¯ä¾èµ–..."
        echo "=== å½“å‰ç›®å½•å†…å®¹ ==="
        ls -la
        
        echo "=== æ£€æŸ¥ package.json ==="
        if [ -f "package.json" ]; then
          echo "âœ… package.json å­˜åœ¨"
          cat package.json | head -10
        else
          echo "âŒ package.json ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "=== æ£€æŸ¥ package-lock.json ==="
        if [ -f "package-lock.json" ]; then
          echo "âœ… package-lock.json å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < package-lock.json) å­—èŠ‚"
          echo "lockfileVersion: $(grep -o '"lockfileVersion": [0-9]*' package-lock.json | head -1)"
        else
          echo "âŒ package-lock.json ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ npm install"
        fi
        
        echo "=== æ£€æŸ¥ Node.js å’Œ npm ç‰ˆæœ¬ ==="
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        
        echo "ğŸ“¦ å°è¯•ä½¿ç”¨ npm ci å®‰è£…ä¾èµ–..."
        if npm ci --verbose; then
          echo "âœ… npm ci å®‰è£…æˆåŠŸ"
        else
          echo "âŒ npm ci å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm install..."
          echo "=== æ¸…ç†å¯èƒ½çš„æŸåçŠ¶æ€ ==="
          rm -rf node_modules package-lock.json
          echo "=== ä½¿ç”¨ npm install é‡æ–°å®‰è£…å’Œç”Ÿæˆ lock æ–‡ä»¶ ==="
          npm install --verbose
          echo "âœ… npm install å®‰è£…æˆåŠŸ"
        fi
        
        echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
        if [ -d "node_modules" ]; then
          echo "âœ… node_modules ç›®å½•å­˜åœ¨"
          echo "å·²å®‰è£…åŒ…æ•°é‡: $(find node_modules -maxdepth 1 -type d | wc -l)"
        else
          echo "âŒ node_modules ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # æ„å»ºæµ‹è¯•
  build:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install docker-compose
      run: sudo apt-get update && sudo apt-get install -y docker-compose
      
    - name: Create test environment file
      run: |
        cat > .env << EOF
        # æµ‹è¯•ç¯å¢ƒ - ä½¿ç”¨æœ¬åœ°å®¹å™¨æœåŠ¡
        MONGODB_HOST=mongodb
        MONGODB_PORT=27017
        MONGODB_DATABASE=ai_novel_db
        REDIS_HOST=redis
        REDIS_PORT=6379
        REDIS_PASSWORD=Lekairong350702
        # AI æœåŠ¡é…ç½®
        SILICONFLOW_API_KEY=sk-test-key
        JWT_SECRET_KEY=test-jwt-secret-key
        # MySQL æ•°æ®åº“é…ç½®ï¼ˆä»ä½¿ç”¨äº‘æœåŠ¡ï¼Œä½†CIç¯å¢ƒå¯èƒ½æ— æ³•è¿æ¥ï¼‰
        DATABASE_SYSTEMHOST=172.16.16.3
        DATABASE_SYSTEM=novel_data
        DATABASE_USER=lkr
        DATABASE_PASSWORD=Lekairong350702
        DATABASE_NOVELHOST=172.16.16.2
        DATABASE_NOVELDATA=novel_user_data
        DATABASE_NOVELUSER=novel_data_user
        DATABASE_NOVELUSER_PASSWORD=Lekairong350702
        # æœåŠ¡é…ç½®
        SERVER_IP=localhost
        MCP_SERVER_NAME=novel-ai-server
        MCP_SERVER_PORT=8000
        MCP_SERVER_HOST=localhost
        MCP_TOOLS_ENABLED=true
        MCP_TOOLS_LIST=novel_generation,character_creation,plot_analysis,content_review,style_transfer
        NOVEL_GENERATION_MAX_TOKENS=4096
        NOVEL_GENERATION_TEMPERATURE=0.8
        NOVEL_GENERATION_TOP_P=0.9
        SILICONFLOW_DEFAULT_MODEL=deepseek-ai/DeepSeek-V3
        SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
        EOF
      
    - name: æå‡ MongoDB vm.max_map_count å‚æ•°
      run: sudo sysctl -w vm.max_map_count=1677720
      
    - name: Build Docker images
      run: docker-compose build --no-cache
    
    - name: Verify Docker network setup
      run: |
        echo "ğŸ” éªŒè¯ Docker Compose é…ç½®..."
        echo "=== å½“å‰å·¥ä½œç›®å½• ==="
        echo "PWD: $PWD"
        echo "PROJECT: $(basename $PWD)"
        
        echo "=== æ£€æŸ¥ç½‘ç»œé…ç½® ==="
        # éªŒè¯ docker-compose.yml ä¸­çš„ç½‘ç»œé…ç½®
        if docker-compose config | grep -A 3 "networks:" | grep -q "app-network"; then
          echo "âœ… å‘ç° app-network é…ç½®"
          docker-compose config | grep -A 10 "networks:"
        else
          echo "âŒ app-network é…ç½®ç¼ºå¤±ï¼Œæ£€æŸ¥ docker-compose.yml"
          exit 1
        fi
        
        echo "ğŸš€ æµ‹è¯•ç½‘ç»œåˆ›å»º..."
        docker-compose up -d --no-deps mongodb redis
        sleep 15
        
        echo "=== å½“å‰ç½‘ç»œåˆ—è¡¨ ==="
        docker network ls
        
        echo "=== æ™ºèƒ½ç½‘ç»œæ£€æµ‹ ==="
        # ä½¿ç”¨å¢å¼ºçš„ç½‘ç»œæ£€æµ‹è„šæœ¬
        chmod +x scripts/simple-network-check.sh
        
        echo "ğŸ” æ‰§è¡Œç½‘ç»œæ£€æµ‹è„šæœ¬..."
        if bash scripts/simple-network-check.sh; then
          NETWORK_CHECK_SUCCESS=true
        else
          NETWORK_CHECK_SUCCESS=false
          echo "âš ï¸ ç½‘ç»œæ£€æµ‹è„šæœ¬è¿”å›å¤±è´¥çŠ¶æ€ï¼Œä½†ç»§ç»­æ£€æŸ¥ç»“æœ"
        fi
        
        # ç¡®ä¿ç¯å¢ƒå˜é‡æ–‡ä»¶å­˜åœ¨å¹¶å¯è¯»
        if [ -f /tmp/detected_network.env ]; then
          echo "=== æ£€æµ‹ç»“æœæ–‡ä»¶å†…å®¹ ==="
          cat /tmp/detected_network.env
          
          # åŠ è½½æ£€æµ‹ç»“æœ
          source /tmp/detected_network.env
          
          # éªŒè¯å˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
          if [ -n "$DETECTED_NETWORK_NAME" ] && [ "$NETWORK_EXISTS" = "true" ]; then
            echo "âœ… ç½‘ç»œæ£€æµ‹æˆåŠŸ: $DETECTED_NETWORK_NAME"
          else
            echo "âš ï¸ ç½‘ç»œæ£€æµ‹ç»“æœæ˜¾ç¤ºç½‘ç»œä¸å­˜åœ¨æˆ–æ— æ•ˆ"
            echo "DETECTED_NETWORK_NAME: '$DETECTED_NETWORK_NAME'"
            echo "NETWORK_EXISTS: '$NETWORK_EXISTS'"
            
            # å°è¯•ä½¿ç”¨docker-composeåˆ›å»ºç½‘ç»œ
            echo "ğŸ”§ å°è¯•é€šè¿‡docker-composeåˆ›å»ºç½‘ç»œ..."
            docker-compose up --no-start 2>/dev/null || true
            sleep 5
            
            # é‡æ–°æ£€æŸ¥
            echo "ğŸ” é‡æ–°æ£€æŸ¥ç½‘ç»œçŠ¶æ€..."
            docker network ls
            
            # å†æ¬¡å°è¯•æ£€æµ‹
            if bash scripts/simple-network-check.sh; then
              source /tmp/detected_network.env
              if [ -n "$DETECTED_NETWORK_NAME" ] && [ "$NETWORK_EXISTS" = "true" ]; then
                echo "âœ… é‡è¯•åç½‘ç»œæ£€æµ‹æˆåŠŸ: $DETECTED_NETWORK_NAME"
              else
                echo "âŒ é‡è¯•åä»ç„¶æ— æ³•æ£€æµ‹åˆ°ç½‘ç»œï¼Œç»§ç»­æ‰§è¡Œä½†å¯èƒ½ä¼šæœ‰é—®é¢˜"
              fi
            else
              echo "âŒ é‡è¯•ç½‘ç»œæ£€æµ‹ä»ç„¶å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
            fi
          fi
        else
          echo "âŒ ç½‘ç»œæ£€æµ‹ç»“æœæ–‡ä»¶ä¸å­˜åœ¨"
          echo "ğŸ”§ åˆ›å»ºé»˜è®¤ç½‘ç»œæ£€æµ‹ç»“æœ..."
          echo "DETECTED_NETWORK_NAME=app-network" > /tmp/detected_network.env
          echo "NETWORK_EXISTS=unknown" >> /tmp/detected_network.env
          echo "âš ï¸ ä½¿ç”¨é»˜è®¤ç½‘ç»œåç§°ç»§ç»­æ‰§è¡Œ"
        fi
        
        echo "ğŸ” æµ‹è¯•æœåŠ¡é—´ç½‘ç»œé€šä¿¡..."
        # æµ‹è¯• MongoDB æœåŠ¡å‘ç°
        if docker-compose exec -T mongodb mongosh --eval "db.adminCommand('ping')" 2>/dev/null; then
          echo "âœ… MongoDB æœåŠ¡å¯é€šè¿‡ç½‘ç»œè®¿é—®"
        else
          echo "âŒ MongoDB ç½‘ç»œè®¿é—®å¤±è´¥"
        fi
        
        # æµ‹è¯• Redis æœåŠ¡å‘ç°
        if docker-compose exec -T redis redis-cli ping 2>/dev/null; then
          echo "âœ… Redis æœåŠ¡å¯é€šè¿‡ç½‘ç»œè®¿é—®"
        else
          echo "âŒ Redis ç½‘ç»œè®¿é—®å¤±è´¥"
        fi
        
        echo "ğŸ›‘ åœæ­¢æµ‹è¯•å®¹å™¨..."
        docker-compose down

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: [quality-check, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Deploy to production server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        PERSONAL_ACCESS_TOKEN: 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
      run: |
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_script.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²AIå°è¯´ç¼–è¾‘å™¨..."
        
        # è®¾ç½®éƒ¨ç½²ç›®å½•
        PROJECT_DIR="/opt/ai-novel-editor"
        BACKUP_DIR="/opt/backups/ai-novel-editor-$(date +%Y%m%d_%H%M%S)"
        
        # åˆ›å»ºç›®å½•
        sudo mkdir -p "$PROJECT_DIR"
        sudo mkdir -p "$(dirname "$BACKUP_DIR")"
        sudo chown $USER:$USER "$PROJECT_DIR"
        sudo chown $USER:$USER "$(dirname "$BACKUP_DIR")"
        
        # å¤‡ä»½ç°æœ‰éƒ¨ç½²
        if [ -d "$PROJECT_DIR/.git" ]; then
          echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
          cp -r "$PROJECT_DIR" "$BACKUP_DIR"
          echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
        fi
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$PROJECT_DIR"
        
        # å…‹éš†æˆ–æ›´æ–°ä»£ç 
        if [ -d ".git" ]; then
          echo "ğŸ“¦ æ›´æ–°ç°æœ‰Gitä»“åº“..."
          if git fetch origin && git reset --hard origin/main && git clean -fd; then
            echo "âœ… ä»£ç æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ Gitæ›´æ–°å¤±è´¥ï¼Œå°è¯•é‡æ–°å…‹éš†..."
            cd ..
            rm -rf "$PROJECT_DIR"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # ä½¿ç”¨æ”¹è¿›çš„å…‹éš†é€»è¾‘
            echo "ğŸ”„ é‡æ–°å…‹éš†ä»£ç ä»“åº“..."
            echo "ğŸ“‹ ä»“åº“ä¿¡æ¯ï¼š"
            echo "  - ä»“åº“åç§°: $GITHUB_REPOSITORY"
            echo "  - Tokenå‰ç¼€: ${PERSONAL_ACCESS_TOKEN:0:10}..."
            echo "  - å…‹éš†åœ°å€: https://***@github.com/$GITHUB_REPOSITORY"
            
            if git clone https://$PERSONAL_ACCESS_TOKEN@github.com/$GITHUB_REPOSITORY .; then
              echo "âœ… ä½¿ç”¨Tokené‡æ–°å…‹éš†æˆåŠŸ"
            else
              echo "âŒ Tokenå…‹éš†å¤±è´¥"
              echo "é”™è¯¯è¯¦æƒ…ï¼š"
              echo "1. PERSONAL_ACCESS_TOKENå‰ç¼€: ${PERSONAL_ACCESS_TOKEN:0:10}..."
              echo "2. ä»“åº“è·¯å¾„: $GITHUB_REPOSITORY"
              exit 1
            fi
          fi
        else
          echo "ğŸ“¦ åˆå§‹åŒ–Gitä»“åº“..."
          # ç¡®ä¿ç›®å½•ä¸ºç©º
          if [ "$(ls -A . 2>/dev/null)" ]; then
            echo "âš ï¸  ç›®å½•ä¸ä¸ºç©ºï¼Œæ¸…ç†ç°æœ‰æ–‡ä»¶..."
            find . -maxdepth 1 -not -name '.' -not -name '..' -exec rm -rf {} + 2>/dev/null || true
          fi
          echo "ğŸ”„ å…‹éš†ä»£ç ä»“åº“..."
          echo "ğŸ“‹ ä»“åº“ä¿¡æ¯ï¼š"
          echo "  - ä»“åº“åç§°: $GITHUB_REPOSITORY"
          echo "  - Tokenå‰ç¼€: ${PERSONAL_ACCESS_TOKEN:0:10}..."
          echo "  - å…‹éš†åœ°å€: https://***@github.com/$GITHUB_REPOSITORY"
          
          # ä½¿ç”¨Tokenè¿›è¡Œå…‹éš†
          for i in {1..3}; do
            echo "å°è¯•ç¬¬ $i æ¬¡å…‹éš†..."
            
            if git clone https://$PERSONAL_ACCESS_TOKEN@github.com/$GITHUB_REPOSITORY .; then
              echo "âœ… å…‹éš†æˆåŠŸ"
              break
            else
              echo "âŒ å…‹éš†å¤±è´¥"
              if [ $i -eq 3 ]; then
                echo "âŒ æ‰€æœ‰å…‹éš†å°è¯•éƒ½å¤±è´¥äº†"
                echo "è¯·æ£€æŸ¥ï¼š"
                echo "1. PERSONAL_ACCESS_TOKENæ˜¯å¦æ­£ç¡®: ${PERSONAL_ACCESS_TOKEN:0:10}..."
                echo "2. Tokenæ˜¯å¦æœ‰repoæƒé™"
                echo "3. ä»“åº“åç§°æ˜¯å¦æ­£ç¡®: $GITHUB_REPOSITORY"
                exit 1
              else
                echo "ç­‰å¾…5ç§’åé‡è¯•..."
                sleep 5
              fi
            fi
          done
        fi
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
        cat > .env << EOF
        # æœåŠ¡å™¨é…ç½®
        SERVER_IP=$SERVER_IP
        SERVER_USER=root
        SERVER_SSH_PORT=22
        SERVER_PORT=22
        # AI æœåŠ¡é…ç½®
        SILICONFLOW_API_KEY=$SILICONFLOW_API_KEY
        SILICONFLOW_DEFAULT_MODEL=deepseek-ai/DeepSeek-V3
        SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
        JWT_SECRET_KEY=$JWT_SECRET_KEY
        # MCP æœåŠ¡é…ç½®
        MCP_SERVER_NAME=novel-ai-server
        MCP_SERVER_PORT=8000
        MCP_SERVER_HOST=$SERVER_IP
        MCP_TOOLS_ENABLED=true
        MCP_TOOLS_LIST=novel_generation,character_creation,plot_analysis,content_review,style_transfer
        NOVEL_GENERATION_MAX_TOKENS=4096
        NOVEL_GENERATION_TEMPERATURE=0.8
        NOVEL_GENERATION_TOP_P=0.9
        # äº‘æ•°æ®åº“é…ç½® - ä½¿ç”¨å†…ç½‘ IP
        MONGODB_HOST=172.16.32.2
        MONGODB_PORT=27017
        MONGODB_DATABASE=ai_novel_db
        REDIS_HOST=172.16.32.2
        REDIS_PORT=6379
        REDIS_PASSWORD=$REDIS_PASSWORD
        # MySQL æ•°æ®åº“é…ç½®
        DATABASE_PORT=3306
        DATABASE_SYSTEMHOST=172.16.16.3
        DATABASE_SYSTEM=novel_data
        DATABASE_USER=lkr
        DATABASE_PASSWORD=Lekairong350702
        DATABASE_NOVELHOST=172.16.16.2
        DATABASE_NOVELDATA=novel_user_data
        DATABASE_NOVELUSER=novel_data_user
        DATABASE_NOVELUSER_PASSWORD=Lekairong350702
        EOF
        
        echo "ğŸ” éªŒè¯äº‘æ•°æ®åº“é…ç½®..."
        echo "MongoDB: 172.16.32.2:27017/ai_novel_db"
        echo "MySQLç³»ç»Ÿåº“: 172.16.16.3:3306/novel_data"
        echo "MySQLç”¨æˆ·åº“: 172.16.16.2:3306/novel_user_data"
        echo "Redis: 172.16.32.2:6379"
        
        # æ£€æŸ¥æ•°æ®åº“æœåŠ¡å¯è¾¾æ€§
        echo "ğŸ” æ£€æŸ¥æ•°æ®åº“æœåŠ¡å¯è¾¾æ€§..."
        
        # æ£€æŸ¥ MongoDB
        if timeout 10 bash -c "echo > /dev/tcp/172.16.32.2/27017" 2>/dev/null; then
          echo "âœ… MongoDB (172.16.32.2:27017) å¯è¿æ¥"
        else
          echo "âŒ MongoDB (172.16.32.2:27017) è¿æ¥å¤±è´¥"
          echo "è¯·æ£€æŸ¥ï¼š"
          echo "1. MongoDB æœåŠ¡æ˜¯å¦å¯åŠ¨: sudo systemctl status mongod"
          echo "2. MongoDB ç»‘å®šåœ°å€: grep bindIp /etc/mongod.conf"
          echo "3. é˜²ç«å¢™è®¾ç½®: sudo ufw status | grep 27017"
          echo "4. ç«¯å£ç›‘å¬: netstat -tlnp | grep 27017"
        fi
        
        # æ£€æŸ¥ Redis
        if timeout 10 bash -c "echo > /dev/tcp/172.16.32.2/6379" 2>/dev/null; then
          echo "âœ… Redis (172.16.32.2:6379) å¯è¿æ¥"
        else
          echo "âŒ Redis (172.16.32.2:6379) è¿æ¥å¤±è´¥"
        fi
        
        # æ£€æŸ¥ MySQL
        if timeout 10 bash -c "echo > /dev/tcp/172.16.16.3/3306" 2>/dev/null; then
          echo "âœ… MySQL ç³»ç»Ÿåº“ (172.16.16.3:3306) å¯è¿æ¥"
        else
          echo "âŒ MySQL ç³»ç»Ÿåº“è¿æ¥å¤±è´¥"
        fi
        
        if timeout 10 bash -c "echo > /dev/tcp/172.16.16.2/3306" 2>/dev/null; then
          echo "âœ… MySQL ç”¨æˆ·åº“ (172.16.16.2:3306) å¯è¿æ¥"
        else
          echo "âŒ MySQL ç”¨æˆ·åº“è¿æ¥å¤±è´¥"
        fi
        
        # æå‡ MongoDB vm.max_map_count å‚æ•°ï¼ˆè™½ç„¶ç”¨äº‘æ•°æ®åº“ï¼Œä½†ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰
        echo "âš™ï¸  æå‡ MongoDB vm.max_map_count å‚æ•°..."
        sudo sysctl -w vm.max_map_count=1677720
        echo "âœ… vm.max_map_count å·²è®¾ç½®ä¸º 1677720"
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x scripts/*.sh || true
        
        # åœæ­¢ç°æœ‰æœåŠ¡
        echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
        docker-compose -f docker-compose.production.yml down || true
        
        # æ¸…ç†Dockerç¼“å­˜
        echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
        docker system prune -f || true
        
        # æ„å»ºå’Œå¯åŠ¨æœåŠ¡
        echo "ğŸ”§ æ„å»ºå’Œå¯åŠ¨æœåŠ¡..."
        docker-compose -f docker-compose.production.yml build --no-cache
        
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        docker-compose -f docker-compose.production.yml up -d
        
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
        # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€..."
        chmod +x scripts/check-backend-health.sh
        
        # ä½¿ç”¨ä¸“é—¨çš„å¥åº·æ£€æŸ¥è„šæœ¬
        if bash scripts/check-backend-health.sh localhost 8000 10 15; then
            echo "âœ… ç”Ÿäº§ç¯å¢ƒåç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
        else
            echo "âŒ ç”Ÿäº§ç¯å¢ƒåç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            echo "ğŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
            docker-compose -f docker-compose.production.yml ps
            echo "ğŸ“‹ æ£€æŸ¥åç«¯æ—¥å¿—..."
            docker-compose -f docker-compose.production.yml logs --tail=50 backend
            
            # æ‰§è¡Œç”Ÿäº§ç¯å¢ƒç‰¹å®šè¯Šæ–­
            echo "ğŸ” æ‰§è¡Œç”Ÿäº§ç¯å¢ƒè¯Šæ–­..."
            chmod +x scripts/production-diagnostics.sh
            NODE_ENV=production bash scripts/production-diagnostics.sh
            
            echo "âŒ åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥"
            docker-compose -f docker-compose.production.yml logs backend
            exit 1
        fi
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        SCRIPT_EOF
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        scp deploy_script.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "export SERVER_IP=\"$SERVER_IP\" && \
           export SILICONFLOW_API_KEY=\"$SILICONFLOW_API_KEY\" && \
           export JWT_SECRET_KEY=\"$JWT_SECRET_KEY\" && \
           export REDIS_PASSWORD=\"$REDIS_PASSWORD\" && \
           export PERSONAL_ACCESS_TOKEN=\"$PERSONAL_ACCESS_TOKEN\" && \
           export GITHUB_REPOSITORY=\"${{ github.repository }}\" && \
           chmod +x /tmp/deploy_script.sh && \
           bash /tmp/deploy_script.sh"
        
    - name: Wait for services to start
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
    - name: Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:8000/health; then
          echo "âœ… åç«¯APIæ­£å¸¸"
        else
          echo "âŒ åç«¯APIå¼‚å¸¸"
          exit 1
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_IP }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.SERVER_IP }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        fi