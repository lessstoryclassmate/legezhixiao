name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        echo "ğŸ“¦ å‡†å¤‡å®‰è£…å‰ç«¯ä¾èµ–..."
        echo "=== å½“å‰ç›®å½•å†…å®¹ ==="
        ls -la
        
        echo "=== æ£€æŸ¥ package.json ==="
        if [ -f "package.json" ]; then
          echo "âœ… package.json å­˜åœ¨"
          cat package.json | head -10
        else
          echo "âŒ package.json ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "=== æ£€æŸ¥ package-lock.json ==="
        if [ -f "package-lock.json" ]; then
          echo "âœ… package-lock.json å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < package-lock.json) å­—èŠ‚"
          echo "lockfileVersion: $(grep -o '"lockfileVersion": [0-9]*' package-lock.json | head -1)"
        else
          echo "âŒ package-lock.json ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ npm install"
        fi
        
        echo "=== æ£€æŸ¥ Node.js å’Œ npm ç‰ˆæœ¬ ==="
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        
        echo "ğŸ“¦ å°è¯•ä½¿ç”¨ npm ci å®‰è£…ä¾èµ–..."
        if npm ci --verbose; then
          echo "âœ… npm ci å®‰è£…æˆåŠŸ"
        else
          echo "âŒ npm ci å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm install..."
          echo "=== æ¸…ç†å¯èƒ½çš„æŸåçŠ¶æ€ ==="
          rm -rf node_modules package-lock.json
          echo "=== ä½¿ç”¨ npm install é‡æ–°å®‰è£…å’Œç”Ÿæˆ lock æ–‡ä»¶ ==="
          npm install --verbose
          echo "âœ… npm install å®‰è£…æˆåŠŸ"
        fi
        
        echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
        if [ -d "node_modules" ]; then
          echo "âœ… node_modules ç›®å½•å­˜åœ¨"
          echo "å·²å®‰è£…åŒ…æ•°é‡: $(find node_modules -maxdepth 1 -type d | wc -l)"
        else
          echo "âŒ node_modules ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # é…ç½®éªŒè¯å’ŒåŸºç¡€æµ‹è¯•
  config-validation:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install docker-compose
      run: sudo apt-get update && sudo apt-get install -y docker-compose
        
    - name: Validate Docker Compose configuration
      run: |
        echo "ğŸ” éªŒè¯ Docker Compose é…ç½®..."
        
        # æ£€æŸ¥å¼€å‘ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… å‘ç°å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶"
          if docker-compose config > /dev/null; then
            echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ å¼€å‘ç¯å¢ƒé…ç½®è¯­æ³•é”™è¯¯"
            exit 1
          fi
        fi
        
        # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.production.yml" ]; then
          echo "âœ… å‘ç°ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶"
          if docker-compose -f docker-compose.production.yml config > /dev/null; then
            echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®è¯­æ³•é”™è¯¯"
            exit 1
          fi
        else
          echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # éªŒè¯ç½‘ç»œé…ç½®
        echo "ğŸ” éªŒè¯ç½‘ç»œé…ç½®..."
        if docker-compose -f docker-compose.production.yml config | grep -A 3 "networks:" | grep -q "app-network"; then
          echo "âœ… å‘ç° app-network é…ç½®"
        else
          echo "âŒ app-network é…ç½®ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate Dockerfiles
      run: |
        echo "ğŸ” éªŒè¯ Dockerfile é…ç½®..."
        
        # æ£€æŸ¥åç«¯ Dockerfile
        if [ -f "backend/Dockerfile" ]; then
          echo "âœ… åç«¯ Dockerfile å­˜åœ¨"
        else
          echo "âŒ åç«¯ Dockerfile ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥å‰ç«¯ Dockerfile
        if [ -f "frontend/Dockerfile" ]; then
          echo "âœ… å‰ç«¯ Dockerfile å­˜åœ¨"
        else
          echo "âŒ å‰ç«¯ Dockerfile ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate deployment scripts
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²è„šæœ¬..."
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶å­˜åœ¨æ€§
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            echo "âœ… å‘ç°è„šæœ¬: $script"
            # æ£€æŸ¥è„šæœ¬è¯­æ³•
            if bash -n "$script"; then
              echo "âœ… è„šæœ¬è¯­æ³•æ­£ç¡®: $script"
            else
              echo "âŒ è„šæœ¬è¯­æ³•é”™è¯¯: $script"
              exit 1
            fi
          fi
        done
        
        echo "âœ… æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: [quality-check, config-validation]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Deploy to production server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        PERSONAL_ACCESS_TOKEN: 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
      run: |
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_script.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²AIå°è¯´ç¼–è¾‘å™¨..."
        
        # é¦–å…ˆè¿è¡Œ Docker é•œåƒåŠ é€Ÿå™¨é…ç½®è„šæœ¬
        echo "ğŸ”§ æ‰§è¡Œ Docker é•œåƒåŠ é€Ÿå™¨é¢„é…ç½®..."
        if [ -f "scripts/setup-docker-mirrors.sh" ]; then
          chmod +x scripts/setup-docker-mirrors.sh
          if bash scripts/setup-docker-mirrors.sh; then
            echo "âœ… Docker é•œåƒåŠ é€Ÿå™¨é¢„é…ç½®æˆåŠŸ"
          else
            echo "âš ï¸ Docker é•œåƒåŠ é€Ÿå™¨é¢„é…ç½®å¤±è´¥ï¼Œç»§ç»­ä½¿ç”¨å†…ç½®é…ç½®"
          fi
        else
          echo "âš ï¸ æœªæ‰¾åˆ° Docker é•œåƒåŠ é€Ÿå™¨é…ç½®è„šæœ¬ï¼Œä½¿ç”¨å†…ç½®é…ç½®"
        fi
        
        # æ£€æŸ¥å’Œå®‰è£…Dockerç¯å¢ƒ
        echo "ğŸ” æ£€æŸ¥Dockerç¯å¢ƒ..."
        
        # æ£€æŸ¥Dockeræ˜¯å¦å®‰è£…
        if ! command -v docker &> /dev/null; then
          echo "âŒ Dockeræœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          
          # æ›´æ–°åŒ…ç´¢å¼•
          sudo apt-get update
          
          # å®‰è£…å¿…è¦çš„åŒ…
          sudo apt-get install -y apt-transport-https ca-certificates curl gnupg lsb-release
          
          # æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          
          # è®¾ç½®ç¨³å®šç‰ˆä»“åº“
          echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          
          # å®‰è£…Docker Engine
          sudo apt-get update
          sudo apt-get install -y docker-ce docker-ce-cli containerd.io
          
          # å¯åŠ¨å¹¶å¯ç”¨DockeræœåŠ¡
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # å°†å½“å‰ç”¨æˆ·æ·»åŠ åˆ°dockerç»„
          sudo usermod -aG docker $USER
          
          echo "âœ… Dockerå®‰è£…å®Œæˆ"
        fi
        
        # é…ç½®Dockeré•œåƒåŠ é€Ÿå™¨
        echo "ğŸ”§ é…ç½®Dockeré•œåƒåŠ é€Ÿå™¨..."
        sudo mkdir -p /etc/docker
        
        # æ£€æŸ¥æ˜¯å¦å·²æœ‰é…ç½®æ–‡ä»¶ï¼Œå¤‡ä»½ç°æœ‰é…ç½®
        if [ -f "/etc/docker/daemon.json" ]; then
          echo "ğŸ“¦ å¤‡ä»½ç°æœ‰Dockeré…ç½®..."
          sudo cp /etc/docker/daemon.json /etc/docker/daemon.json.backup.$(date +%s)
        fi
        
        # åˆ›å»ºæ–°çš„Dockeré…ç½®ï¼Œä¼˜å…ˆä½¿ç”¨å®˜æ–¹é•œåƒæº
        sudo tee /etc/docker/daemon.json > /dev/null <<DOCKER_CONFIG_EOF
        {
          "registry-mirrors": [
            "https://registry-1.docker.io",
            "https://docker.mirrors.ustc.edu.cn",
            "https://hub-mirror.c.163.com",
            "https://mirror.ccs.tencentyun.com",
            "https://registry.docker-cn.com",
            "https://dockerhub.azk8s.cn"
          ],
          "max-concurrent-downloads": 10,
          "max-concurrent-uploads": 5,
          "log-driver": "json-file",
          "log-level": "warn",
          "log-opts": {
            "max-size": "10m",
            "max-file": "3"
          },
          "storage-driver": "overlay2",
          "storage-opts": [
            "overlay2.override_kernel_check=true"
          ],
          "dns": ["8.8.8.8", "114.114.114.114"],
          "insecure-registries": [],
          "live-restore": true
        }
        DOCKER_CONFIG_EOF
        
        # é‡å¯DockeræœåŠ¡ä»¥åº”ç”¨é•œåƒåŠ é€Ÿå™¨é…ç½®
        echo "ğŸ”„ é‡å¯DockeræœåŠ¡ä»¥åº”ç”¨é•œåƒåŠ é€Ÿå™¨é…ç½®..."
        sudo systemctl daemon-reload
        sudo systemctl restart docker
        
        # ç­‰å¾…DockeræœåŠ¡å®Œå…¨å¯åŠ¨
        echo "â³ ç­‰å¾…DockeræœåŠ¡å®Œå…¨å¯åŠ¨..."
        sleep 10
        
        # éªŒè¯DockeræœåŠ¡çŠ¶æ€
        if sudo systemctl is-active --quiet docker; then
          echo "âœ… DockeræœåŠ¡é‡å¯æˆåŠŸ"
        else
          echo "âŒ DockeræœåŠ¡é‡å¯å¤±è´¥"
          sudo systemctl status docker
          exit 1
        fi
        
        # éªŒè¯é•œåƒåŠ é€Ÿå™¨é…ç½®
        echo "ğŸ” éªŒè¯é•œåƒåŠ é€Ÿå™¨é…ç½®..."
        if docker info | grep -A 20 "Registry Mirrors"; then
          echo "âœ… é•œåƒåŠ é€Ÿå™¨é…ç½®æˆåŠŸ"
          docker info | grep -A 20 "Registry Mirrors"
        else
          echo "âš ï¸ æœªæ£€æµ‹åˆ°é•œåƒåŠ é€Ÿå™¨é…ç½®ï¼Œæ£€æŸ¥é…ç½®æ–‡ä»¶"
          sudo cat /etc/docker/daemon.json
        fi
        
        # é¢„ä¸‹è½½å¸¸ç”¨å®˜æ–¹åŸºç¡€é•œåƒ
        echo "ğŸ“¦ é¢„ä¸‹è½½å¸¸ç”¨å®˜æ–¹åŸºç¡€é•œåƒ..."
        PRELOAD_IMAGES=(
          "hello-world:latest"
          "alpine:latest"
          "ubuntu:20.04"
          "node:18-alpine"
          "python:3.11-slim"
          "nginx:alpine"
          "redis:alpine"
        )
        
        for image in "${PRELOAD_IMAGES[@]}"; do
          echo "ğŸ“¦ é¢„ä¸‹è½½é•œåƒ: $image"
          if timeout 180 docker pull "$image"; then
            echo "âœ… æˆåŠŸä¸‹è½½: $image"
          else
            echo "âš ï¸ ä¸‹è½½å¤±è´¥: $image (ç»§ç»­æ‰§è¡Œ)"
          fi
        done
        
        # æµ‹è¯•é•œåƒæ‹‰å–å’Œç½‘ç»œè¿é€šæ€§
        echo "ğŸ” æµ‹è¯•é•œåƒæ‹‰å–å’Œç½‘ç»œè¿é€šæ€§..."
        
        # æµ‹è¯•å®˜æ–¹Docker Hub
        echo "ğŸ” æµ‹è¯•å®˜æ–¹Docker Hubè¿é€šæ€§..."
        if timeout 30 curl -I https://registry-1.docker.io/v2/ 2>/dev/null; then
          echo "âœ… å®˜æ–¹Docker Hubè¿é€šæ€§æ­£å¸¸"
        else
          echo "âš ï¸ å®˜æ–¹Docker Hubè¿é€šæ€§å¼‚å¸¸"
        fi
        
        # æµ‹è¯•é•œåƒæ‹‰å–
        if timeout 120 docker pull hello-world:latest; then
          echo "âœ… é•œåƒæ‹‰å–æµ‹è¯•æˆåŠŸ"
          # æ¸…ç†æµ‹è¯•é•œåƒ
          docker rmi hello-world:latest 2>/dev/null || true
        else
          echo "âŒ é•œåƒæ‹‰å–æµ‹è¯•å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
          echo "ğŸ” Dockerç³»ç»Ÿä¿¡æ¯:"
          docker system info | grep -A 5 "Registry"
        fi
        
        # æ˜¾ç¤ºå·²ä¸‹è½½çš„é•œåƒ
        echo "ğŸ“‹ å½“å‰å·²ä¸‹è½½çš„é•œåƒ:"
        docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}"
        else
          echo "âœ… Dockerå·²å®‰è£…: $(docker --version)"
        fi
        
        # æ£€æŸ¥Docker Composeæ˜¯å¦å®‰è£…
        if ! command -v docker-compose &> /dev/null; then
          echo "âŒ Docker Composeæœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          
          # ä¸‹è½½æœ€æ–°ç‰ˆæœ¬çš„Docker Compose
          DOCKER_COMPOSE_VERSION=$(curl -s https://api.github.com/repos/docker/compose/releases/latest | grep 'tag_name' | cut -d\" -f4)
          sudo curl -L "https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          
          # æ·»åŠ æ‰§è¡Œæƒé™
          sudo chmod +x /usr/local/bin/docker-compose
          
          # åˆ›å»ºç¬¦å·é“¾æ¥
          sudo ln -sf /usr/local/bin/docker-compose /usr/bin/docker-compose
          
          echo "âœ… Docker Composeå®‰è£…å®Œæˆ"
        else
          echo "âœ… Docker Composeå·²å®‰è£…: $(docker-compose --version)"
        fi
        
        # éªŒè¯DockeræœåŠ¡çŠ¶æ€
        echo "ğŸ” éªŒè¯DockeræœåŠ¡çŠ¶æ€..."
        if sudo systemctl is-active --quiet docker; then
          echo "âœ… DockeræœåŠ¡æ­£åœ¨è¿è¡Œ"
        else
          echo "âš ï¸ DockeræœåŠ¡æœªè¿è¡Œï¼Œå°è¯•å¯åŠ¨..."
          sudo systemctl start docker
          sleep 5
          if sudo systemctl is-active --quiet docker; then
            echo "âœ… DockeræœåŠ¡å¯åŠ¨æˆåŠŸ"
          else
            echo "âŒ DockeræœåŠ¡å¯åŠ¨å¤±è´¥"
            sudo systemctl status docker
            exit 1
          fi
        fi
        
        # å¼ºåˆ¶ç¡®ä¿ç”¨æˆ·åœ¨dockerç»„ä¸­
        echo "ğŸ”§ ç¡®ä¿Dockeræƒé™é…ç½®..."
        sudo usermod -aG docker $USER
        
        # å¼ºåˆ¶é‡æ–°åŠ è½½ç”¨æˆ·ç»„ï¼ˆé’ˆå¯¹è„šæœ¬æ‰§è¡Œç¯å¢ƒï¼‰
        if groups $USER | grep -q docker; then
          echo "âœ… ç”¨æˆ·å·²åœ¨dockerç»„ä¸­"
        else
          echo "âš ï¸ ç”¨æˆ·ä¸åœ¨dockerç»„ï¼Œä½†å·²æ·»åŠ ã€‚å¯èƒ½éœ€è¦é‡æ–°ç™»å½•æˆ–ä½¿ç”¨sudo"
        fi
        
        # æµ‹è¯•Dockerå‘½ä»¤ï¼ˆä¼˜å…ˆå°è¯•ä¸ç”¨sudoï¼‰
        echo "ğŸ” æµ‹è¯•Dockerå‘½ä»¤..."
        DOCKER_CMD="docker"
        COMPOSE_CMD="docker-compose"
        
        # å°è¯•ç›´æ¥è¿è¡Œdocker
        if timeout 10 docker run --rm hello-world > /dev/null 2>&1; then
          echo "âœ… Dockerå‘½ä»¤æµ‹è¯•æˆåŠŸï¼ˆæ— éœ€sudoï¼‰"
        else
          echo "âš ï¸ ç›´æ¥è¿è¡Œdockerå¤±è´¥ï¼Œå°è¯•sudo..."
          if timeout 10 sudo docker run --rm hello-world > /dev/null 2>&1; then
            echo "âœ… Dockerå‘½ä»¤(sudo)æµ‹è¯•æˆåŠŸ"
            DOCKER_CMD="sudo docker"
            COMPOSE_CMD="sudo docker-compose"
          else
            echo "âŒ Dockerå‘½ä»¤å®Œå…¨å¤±è´¥ï¼Œæ£€æŸ¥å®‰è£…å’ŒæœåŠ¡çŠ¶æ€"
            sudo systemctl status docker
            sudo docker version || true
            exit 1
          fi
        fi
        
        echo "ğŸ“‹ ä½¿ç”¨Dockerå‘½ä»¤: $DOCKER_CMD"
        echo "ğŸ“‹ ä½¿ç”¨Composeå‘½ä»¤: $COMPOSE_CMD"
        
        # è®¾ç½®éƒ¨ç½²ç›®å½•
        PROJECT_DIR="/opt/ai-novel-editor"
        BACKUP_DIR="/opt/backups/ai-novel-editor-$(date +%Y%m%d_%H%M%S)"
        
        # åˆ›å»ºç›®å½•
        sudo mkdir -p "$PROJECT_DIR"
        sudo mkdir -p "$(dirname "$BACKUP_DIR")"
        sudo chown $USER:$USER "$PROJECT_DIR"
        sudo chown $USER:$USER "$(dirname "$BACKUP_DIR")"
        
        # å¤‡ä»½ç°æœ‰éƒ¨ç½²
        if [ -d "$PROJECT_DIR/.git" ]; then
          echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
          cp -r "$PROJECT_DIR" "$BACKUP_DIR"
          echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
        fi
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$PROJECT_DIR"
        
        # å…‹éš†æˆ–æ›´æ–°ä»£ç 
        if [ -d ".git" ]; then
          echo "ğŸ“¦ æ›´æ–°ç°æœ‰Gitä»“åº“..."
          if git fetch origin && git reset --hard origin/main && git clean -fd; then
            echo "âœ… ä»£ç æ›´æ–°æˆåŠŸ"
          else
            echo "âŒ Gitæ›´æ–°å¤±è´¥ï¼Œå°è¯•é‡æ–°å…‹éš†..."
            cd ..
            rm -rf "$PROJECT_DIR"
            mkdir -p "$PROJECT_DIR"
            cd "$PROJECT_DIR"
            
            # ä½¿ç”¨æ”¹è¿›çš„å…‹éš†é€»è¾‘
            echo "ğŸ”„ é‡æ–°å…‹éš†ä»£ç ä»“åº“..."
            echo "ğŸ“‹ ä»“åº“ä¿¡æ¯ï¼š"
            echo "  - ä»“åº“åç§°: $GITHUB_REPOSITORY"
            echo "  - Tokenå‰ç¼€: ${PERSONAL_ACCESS_TOKEN:0:10}..."
            echo "  - å…‹éš†åœ°å€: https://***@github.com/$GITHUB_REPOSITORY"
            
            if git clone https://$PERSONAL_ACCESS_TOKEN@github.com/$GITHUB_REPOSITORY .; then
              echo "âœ… ä½¿ç”¨Tokené‡æ–°å…‹éš†æˆåŠŸ"
            else
              echo "âŒ Tokenå…‹éš†å¤±è´¥"
              echo "é”™è¯¯è¯¦æƒ…ï¼š"
              echo "1. PERSONAL_ACCESS_TOKENå‰ç¼€: ${PERSONAL_ACCESS_TOKEN:0:10}..."
              echo "2. ä»“åº“è·¯å¾„: $GITHUB_REPOSITORY"
              exit 1
            fi
          fi
        else
          echo "ğŸ“¦ åˆå§‹åŒ–Gitä»“åº“..."
          # ç¡®ä¿ç›®å½•ä¸ºç©º
          if [ "$(ls -A . 2>/dev/null)" ]; then
            echo "âš ï¸  ç›®å½•ä¸ä¸ºç©ºï¼Œæ¸…ç†ç°æœ‰æ–‡ä»¶..."
            find . -maxdepth 1 -not -name '.' -not -name '..' -exec rm -rf {} + 2>/dev/null || true
          fi
          echo "ğŸ”„ å…‹éš†ä»£ç ä»“åº“..."
          echo "ğŸ“‹ ä»“åº“ä¿¡æ¯ï¼š"
          echo "  - ä»“åº“åç§°: $GITHUB_REPOSITORY"
          echo "  - Tokenå‰ç¼€: ${PERSONAL_ACCESS_TOKEN:0:10}..."
          echo "  - å…‹éš†åœ°å€: https://***@github.com/$GITHUB_REPOSITORY"
          
          # ä½¿ç”¨Tokenè¿›è¡Œå…‹éš†
          for i in {1..3}; do
            echo "å°è¯•ç¬¬ $i æ¬¡å…‹éš†..."
            
            if git clone https://$PERSONAL_ACCESS_TOKEN@github.com/$GITHUB_REPOSITORY .; then
              echo "âœ… å…‹éš†æˆåŠŸ"
              break
            else
              echo "âŒ å…‹éš†å¤±è´¥"
              if [ $i -eq 3 ]; then
                echo "âŒ æ‰€æœ‰å…‹éš†å°è¯•éƒ½å¤±è´¥äº†"
                echo "è¯·æ£€æŸ¥ï¼š"
                echo "1. PERSONAL_ACCESS_TOKENæ˜¯å¦æ­£ç¡®: ${PERSONAL_ACCESS_TOKEN:0:10}..."
                echo "2. Tokenæ˜¯å¦æœ‰repoæƒé™"
                echo "3. ä»“åº“åç§°æ˜¯å¦æ­£ç¡®: $GITHUB_REPOSITORY"
                exit 1
              else
                echo "ç­‰å¾…5ç§’åé‡è¯•..."
                sleep 5
              fi
            fi
          done
        fi
        
        # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
        echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
        cat > .env << EOF
        # æœåŠ¡å™¨é…ç½®
        SERVER_IP=$SERVER_IP
        SERVER_USER=root
        SERVER_SSH_PORT=22
        SERVER_PORT=22
        # AI æœåŠ¡é…ç½®
        SILICONFLOW_API_KEY=$SILICONFLOW_API_KEY
        SILICONFLOW_DEFAULT_MODEL=deepseek-ai/DeepSeek-V3
        SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
        JWT_SECRET_KEY=$JWT_SECRET_KEY
        # MCP æœåŠ¡é…ç½®
        MCP_SERVER_NAME=novel-ai-server
        MCP_SERVER_PORT=8000
        MCP_SERVER_HOST=$SERVER_IP
        MCP_TOOLS_ENABLED=true
        MCP_TOOLS_LIST=novel_generation,character_creation,plot_analysis,content_review,style_transfer
        NOVEL_GENERATION_MAX_TOKENS=4096
        NOVEL_GENERATION_TEMPERATURE=0.8
        NOVEL_GENERATION_TOP_P=0.9
        # äº‘æ•°æ®åº“é…ç½® - ä½¿ç”¨å†…ç½‘ IP
        MONGODB_HOST=172.16.32.2
        MONGODB_PORT=27017
        MONGODB_DATABASE=ai_novel_db
        REDIS_HOST=172.16.32.2
        REDIS_PORT=6379
        REDIS_PASSWORD=$REDIS_PASSWORD
        # MySQL æ•°æ®åº“é…ç½®
        DATABASE_PORT=3306
        DATABASE_SYSTEMHOST=172.16.16.3
        DATABASE_SYSTEM=novel_data
        DATABASE_USER=lkr
        DATABASE_PASSWORD=Lekairong350702
        DATABASE_NOVELHOST=172.16.16.2
        DATABASE_NOVELDATA=novel_user_data
        DATABASE_NOVELUSER=novel_data_user
        DATABASE_NOVELUSER_PASSWORD=Lekairong350702
        EOF
        
        echo "ğŸ” éªŒè¯äº‘æ•°æ®åº“é…ç½®..."
        echo "MongoDB: 172.16.32.2:27017/ai_novel_db"
        echo "MySQLç³»ç»Ÿåº“: 172.16.16.3:3306/novel_data"
        echo "MySQLç”¨æˆ·åº“: 172.16.16.2:3306/novel_user_data"
        echo "Redis: 172.16.32.2:6379"
        
        # æ£€æŸ¥æ•°æ®åº“æœåŠ¡å¯è¾¾æ€§ï¼ˆå…³é”®ï¼ï¼ï¼ï¼‰
        echo "ğŸ” æ£€æŸ¥æ•°æ®åº“æœåŠ¡å¯è¾¾æ€§..."
        DB_CHECK_FAILED=false
        
        # æ£€æŸ¥ MongoDB
        echo "ğŸ” æ£€æŸ¥MongoDBè¿æ¥..."
        if timeout 15 bash -c "echo > /dev/tcp/172.16.32.2/27017" 2>/dev/null; then
          echo "âœ… MongoDB (172.16.32.2:27017) ç«¯å£å¯è¿æ¥"
        else
          echo "âŒ MongoDB (172.16.32.2:27017) ç«¯å£è¿æ¥å¤±è´¥"
          DB_CHECK_FAILED=true
          echo "MongoDBæ•…éšœæ’æŸ¥ï¼š"
          echo "  1. æ£€æŸ¥MongoDBæœåŠ¡çŠ¶æ€"
          echo "  2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™"
          echo "  3. æ£€æŸ¥ç½‘ç»œè·¯ç”±"
        fi
        
        # æ£€æŸ¥ Redis
        echo "ğŸ” æ£€æŸ¥Redisè¿æ¥..."
        if timeout 15 bash -c "echo > /dev/tcp/172.16.32.2/6379" 2>/dev/null; then
          echo "âœ… Redis (172.16.32.2:6379) ç«¯å£å¯è¿æ¥"
        else
          echo "âŒ Redis (172.16.32.2:6379) ç«¯å£è¿æ¥å¤±è´¥"
          DB_CHECK_FAILED=true
          echo "Redisæ•…éšœæ’æŸ¥ï¼š"
          echo "  1. æ£€æŸ¥RedisæœåŠ¡çŠ¶æ€"
          echo "  2. æ£€æŸ¥é˜²ç«å¢™è§„åˆ™"
        fi
        
        # æ£€æŸ¥ MySQL ç³»ç»Ÿåº“
        echo "ğŸ” æ£€æŸ¥MySQLç³»ç»Ÿåº“è¿æ¥..."
        if timeout 15 bash -c "echo > /dev/tcp/172.16.16.3/3306" 2>/dev/null; then
          echo "âœ… MySQL ç³»ç»Ÿåº“ (172.16.16.3:3306) ç«¯å£å¯è¿æ¥"
        else
          echo "âŒ MySQL ç³»ç»Ÿåº“ç«¯å£è¿æ¥å¤±è´¥"
          DB_CHECK_FAILED=true
        fi
        
        # æ£€æŸ¥ MySQL ç”¨æˆ·åº“
        echo "ğŸ” æ£€æŸ¥MySQLç”¨æˆ·åº“è¿æ¥..."
        if timeout 15 bash -c "echo > /dev/tcp/172.16.16.2/3306" 2>/dev/null; then
          echo "âœ… MySQL ç”¨æˆ·åº“ (172.16.16.2:3306) ç«¯å£å¯è¿æ¥"
        else
          echo "âŒ MySQL ç”¨æˆ·åº“ç«¯å£è¿æ¥å¤±è´¥"
          DB_CHECK_FAILED=true
        fi
        
        # å¦‚æœæ•°æ®åº“è¿æ¥æœ‰é—®é¢˜ï¼Œç»™å‡ºæ˜ç¡®è­¦å‘Šä½†ä¸é˜»æ­¢éƒ¨ç½²
        if [ "$DB_CHECK_FAILED" = true ]; then
          echo ""
          echo "âš ï¸âš ï¸âš ï¸ æ•°æ®åº“è¿æ¥æ£€æŸ¥å‘ç°é—®é¢˜ âš ï¸âš ï¸âš ï¸"
          echo "è¿™å¾ˆå¯èƒ½æ˜¯åç«¯æœåŠ¡å¯åŠ¨å¤±è´¥çš„æ ¹æœ¬åŸå› ï¼"
          echo "åç«¯æœåŠ¡å°†åœ¨è¿æ¥æ•°æ®åº“æ—¶å¡æ­»æˆ–å¼‚å¸¸é€€å‡ºã€‚"
          echo ""
          echo "å»ºè®®æ“ä½œï¼š"
          echo "1. ç«‹å³æ£€æŸ¥æ•°æ®åº“æœåŠ¡å™¨çŠ¶æ€"
          echo "2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œé˜²ç«å¢™è®¾ç½®"
          echo "3. ç¡®è®¤æ•°æ®åº“é…ç½®æ­£ç¡®"
          echo ""
          echo "ç»§ç»­éƒ¨ç½²ï¼ˆå¯èƒ½å¤±è´¥ï¼‰..."
          sleep 10
        else
          echo "âœ… æ‰€æœ‰æ•°æ®åº“æœåŠ¡ç«¯å£æ£€æŸ¥é€šè¿‡"
        fi
        
        # æå‡ MongoDB vm.max_map_count å‚æ•°ï¼ˆè™½ç„¶ç”¨äº‘æ•°æ®åº“ï¼Œä½†ä¿ç•™ä»¥é˜²ä¸‡ä¸€ï¼‰
        echo "âš™ï¸  æå‡ MongoDB vm.max_map_count å‚æ•°..."
        sudo sysctl -w vm.max_map_count=1677720
        echo "âœ… vm.max_map_count å·²è®¾ç½®ä¸º 1677720"
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x scripts/*.sh || true
        
        # åœæ­¢ç°æœ‰æœåŠ¡
        echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
        $COMPOSE_CMD -f docker-compose.production.yml down --remove-orphans || true
        
        # æ¸…ç†Dockerç¼“å­˜ï¼ˆé€‚åº¦æ¸…ç†ï¼‰
        echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
        $DOCKER_CMD container prune -f || true
        $DOCKER_CMD image prune -f || true
        
        # æ„å»ºæœåŠ¡
        echo "ğŸ”§ æ„å»ºDockeré•œåƒ..."
        BUILD_SUCCESS=false
        
        # é¢„æ£€æŸ¥ï¼šç¡®ä¿ç½‘ç»œè¿é€šæ€§
        echo "ğŸ” é¢„æ£€æŸ¥ç½‘ç»œè¿é€šæ€§..."
        if ! timeout 30 curl -f -s https://registry-1.docker.io/v2/ > /dev/null; then
          echo "âš ï¸ å®˜æ–¹Docker Hubè¿é€šæ€§å¼‚å¸¸ï¼Œå°è¯•ä¿®å¤..."
          if [ -f "scripts/fix-docker-network.sh" ]; then
            bash scripts/fix-docker-network.sh || true
          fi
        fi
        
        for i in {1..5}; do
          echo "ğŸ”§ ç¬¬ $i æ¬¡æ„å»ºå°è¯•..."
          
          # æ¸…ç†æ„å»ºç¼“å­˜é˜²æ­¢å†²çª
          if [ $i -gt 1 ]; then
            echo "ğŸ§¹ æ¸…ç†æ„å»ºç¼“å­˜å’Œç½‘ç»œçŠ¶æ€..."
            $DOCKER_CMD builder prune -f || true
            $DOCKER_CMD system prune -f || true
            
            # é‡å¯DockeræœåŠ¡ï¼ˆä»ç¬¬3æ¬¡å°è¯•å¼€å§‹ï¼‰
            if [ $i -ge 3 ]; then
              echo "ğŸ”„ é‡å¯DockeræœåŠ¡ä»¥é‡ç½®ç½‘ç»œçŠ¶æ€..."
              sudo systemctl restart docker
              sleep 20
              
              # éªŒè¯æœåŠ¡çŠ¶æ€
              if ! sudo systemctl is-active --quiet docker; then
                echo "âŒ DockeræœåŠ¡é‡å¯å¤±è´¥"
                continue
              fi
            fi
            
            # è¿è¡Œç½‘ç»œä¿®å¤è„šæœ¬ï¼ˆä»ç¬¬4æ¬¡å°è¯•å¼€å§‹ï¼‰
            if [ $i -ge 4 ] && [ -f "scripts/fix-docker-network.sh" ]; then
              echo "ğŸ”§ æ‰§è¡Œç½‘ç»œä¿®å¤è„šæœ¬..."
              bash scripts/fix-docker-network.sh || true
            fi
          fi
          
          # è®¾ç½®æ„å»ºç¯å¢ƒå˜é‡ï¼Œä¼˜åŒ–ç½‘ç»œè¶…æ—¶
          export DOCKER_BUILDKIT=1
          export BUILDKIT_PROGRESS=plain
          export COMPOSE_HTTP_TIMEOUT=300
          export DOCKER_CLIENT_TIMEOUT=300
          
          # å°è¯•æ„å»ºï¼ˆå¢åŠ è¶…æ—¶æ—¶é—´ï¼‰
          echo "ğŸ“¦ å¼€å§‹æ„å»ºï¼Œè¶…æ—¶è®¾ç½®ä¸º2400ç§’..."
          if timeout 2400 $COMPOSE_CMD -f docker-compose.production.yml build --no-cache --parallel; then
            echo "âœ… ç¬¬ $i æ¬¡æ„å»ºæˆåŠŸ"
            BUILD_SUCCESS=true
            break
          else
            echo "âŒ ç¬¬ $i æ¬¡æ„å»ºå¤±è´¥"
            
            # æ˜¾ç¤ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            echo "ğŸ“‹ Docker ç³»ç»Ÿä¿¡æ¯ï¼š"
            $DOCKER_CMD system df || true
            echo "ğŸ“‹ Docker ç½‘ç»œçŠ¶æ€ï¼š"
            $DOCKER_CMD network ls || true
            
            # æ£€æŸ¥æ˜¯å¦æ˜¯ç½‘ç»œè¶…æ—¶é”™è¯¯
            echo "ğŸ” æ£€æŸ¥é”™è¯¯ç±»å‹..."
            if $COMPOSE_CMD -f docker-compose.production.yml logs 2>&1 | grep -i "timeout\|connection.*refused\|network"; then
              echo "ğŸŒ æ£€æµ‹åˆ°ç½‘ç»œç›¸å…³é”™è¯¯"
            fi
            
            if [ $i -lt 5 ]; then
              echo "â³ ç­‰å¾…60ç§’åé‡è¯•..."
              sleep 60
            fi
          fi
        done
        
        if [ "$BUILD_SUCCESS" = false ]; then
          echo "âŒ æ‰€æœ‰æ„å»ºå°è¯•éƒ½å¤±è´¥äº†"
          echo "ğŸ“‹ æœ€ç»ˆDockerçŠ¶æ€æ£€æŸ¥ï¼š"
          $DOCKER_CMD system info | head -50 || true
          $DOCKER_CMD system df || true
          echo "ğŸ“‹ ç½‘ç»œè¿é€šæ€§æœ€ç»ˆæµ‹è¯•ï¼š"
          curl -I https://registry-1.docker.io/v2/ || true
          echo "ğŸ“‹ æ„å»ºæ—¥å¿—ï¼š"
          $COMPOSE_CMD -f docker-compose.production.yml logs || true
          exit 1
        fi
        
        # å¯åŠ¨æœåŠ¡
        echo "ğŸš€ å¯åŠ¨æœåŠ¡..."
        STARTUP_SUCCESS=false
        for i in {1..3}; do
          echo "ğŸš€ ç¬¬ $i æ¬¡å¯åŠ¨å°è¯•..."
          
          # ç¡®ä¿å…ˆåœæ­¢æ‰€æœ‰æœåŠ¡
          $COMPOSE_CMD -f docker-compose.production.yml down --remove-orphans || true
          
          # ç­‰å¾…ä¸€ä¸‹ç¡®ä¿æœåŠ¡å®Œå…¨åœæ­¢
          sleep 10
          
          # å°è¯•å¯åŠ¨æœåŠ¡
          if $COMPOSE_CMD -f docker-compose.production.yml up -d; then
            echo "âœ… ç¬¬ $i æ¬¡å¯åŠ¨å‘½ä»¤æ‰§è¡ŒæˆåŠŸ"
            
            # ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
            echo "â³ ç­‰å¾…æœåŠ¡åˆå§‹åŒ–..."
            sleep 30
            
            # æ£€æŸ¥å®¹å™¨çŠ¶æ€
            if $COMPOSE_CMD -f docker-compose.production.yml ps | grep -q "Up"; then
              echo "âœ… ç¬¬ $i æ¬¡å¯åŠ¨éªŒè¯æˆåŠŸ"
              STARTUP_SUCCESS=true
              break
            else
              echo "âŒ ç¬¬ $i æ¬¡å¯åŠ¨éªŒè¯å¤±è´¥"
              $COMPOSE_CMD -f docker-compose.production.yml ps
              $COMPOSE_CMD -f docker-compose.production.yml logs --tail=50
            fi
          else
            echo "âŒ ç¬¬ $i æ¬¡å¯åŠ¨å‘½ä»¤å¤±è´¥"
          fi
          
          if [ $i -lt 3 ]; then
            echo "â³ ç­‰å¾…15ç§’åé‡è¯•..."
            sleep 15
          fi
        done
        
        if [ "$STARTUP_SUCCESS" = false ]; then
          echo "âŒ æ‰€æœ‰å¯åŠ¨å°è¯•éƒ½å¤±è´¥äº†"
          echo "ğŸ“‹ æœ€ç»ˆçŠ¶æ€æ£€æŸ¥ï¼š"
          $COMPOSE_CMD -f docker-compose.production.yml ps
          $COMPOSE_CMD -f docker-compose.production.yml logs
          exit 1
        fi
        
        # ç«‹å³æ£€æŸ¥å®¹å™¨çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
        $COMPOSE_CMD -f docker-compose.production.yml ps
        
        # åˆ†é˜¶æ®µç­‰å¾…å’Œæ£€æŸ¥
        echo "â³ ç­‰å¾…æœåŠ¡åˆå§‹åŒ–..."
        sleep 30
        
        # æ£€æŸ¥å®¹å™¨æ˜¯å¦è¿˜åœ¨è¿è¡Œ
        echo "ğŸ” æ£€æŸ¥å®¹å™¨è¿è¡ŒçŠ¶æ€..."
        if $COMPOSE_CMD -f docker-compose.production.yml ps | grep -q "Up"; then
          echo "âœ… è‡³å°‘æœ‰å®¹å™¨åœ¨è¿è¡Œ"
        else
          echo "âŒ æ²¡æœ‰å®¹å™¨åœ¨è¿è¡Œï¼Œæ£€æŸ¥å¯åŠ¨æ—¥å¿—"
          $COMPOSE_CMD -f docker-compose.production.yml ps
          $COMPOSE_CMD -f docker-compose.production.yml logs
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯å®¹å™¨çŠ¶æ€
        echo "ğŸ” ä¸“é¡¹æ£€æŸ¥åç«¯å®¹å™¨..."
        if $COMPOSE_CMD -f docker-compose.production.yml ps backend | grep -q "Up"; then
          echo "âœ… åç«¯å®¹å™¨æ­£åœ¨è¿è¡Œ"
          
          # æ˜¾ç¤ºåç«¯å®¹å™¨æ—¥å¿—é¢„è§ˆ
          echo "ğŸ“‹ åç«¯å®¹å™¨å¯åŠ¨æ—¥å¿—é¢„è§ˆ:"
          $COMPOSE_CMD -f docker-compose.production.yml logs --tail=20 backend
          
        else
          echo "âŒ åç«¯å®¹å™¨æœªè¿è¡Œæˆ–å·²é€€å‡º"
          echo "ğŸ“‹ åç«¯å®¹å™¨çŠ¶æ€:"
          $COMPOSE_CMD -f docker-compose.production.yml ps backend
          echo "ğŸ“‹ åç«¯å®¹å™¨æ—¥å¿—:"
          $COMPOSE_CMD -f docker-compose.production.yml logs backend
          
          echo "âŒ åç«¯å®¹å™¨å¯åŠ¨å¤±è´¥ï¼Œä¸­æ­¢éƒ¨ç½²"
          exit 1
        fi
        
        # ç»§ç»­ç­‰å¾…æœåŠ¡ç¨³å®š
        echo "â³ ç­‰å¾…æœåŠ¡ç¨³å®šè¿è¡Œ..."
        sleep 30
        
        # å†æ¬¡æ£€æŸ¥å®¹å™¨çŠ¶æ€
        echo "ğŸ” äºŒæ¬¡æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
        $COMPOSE_CMD -f docker-compose.production.yml ps
        
        # æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€
        echo "ğŸ” å¼€å§‹å¥åº·æ£€æŸ¥..."
        chmod +x scripts/check-backend-health.sh || echo "å¥åº·æ£€æŸ¥è„šæœ¬ä¸å­˜åœ¨ï¼Œä½¿ç”¨å†…ç½®æ£€æŸ¥"
        
        # å°è¯•å¥åº·æ£€æŸ¥
        HEALTH_CHECK_SUCCESS=false
        for i in {1..5}; do
          echo "ğŸ” ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥å°è¯•..."
          
          # ç®€å•çš„HTTPæ£€æŸ¥
          if curl -f --max-time 15 --connect-timeout 10 http://localhost:8000/health 2>/dev/null; then
            echo "âœ… åç«¯å¥åº·æ£€æŸ¥é€šè¿‡"
            HEALTH_CHECK_SUCCESS=true
            break
          elif curl -f --max-time 15 --connect-timeout 10 http://localhost:8000/ 2>/dev/null; then
            echo "âœ… åç«¯æ ¹è·¯å¾„å¯è®¿é—®"
            HEALTH_CHECK_SUCCESS=true
            break
          else
            echo "âŒ ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥"
            if [ $i -lt 5 ]; then
              echo "ç­‰å¾…15ç§’åé‡è¯•..."
              sleep 15
            fi
          fi
        done
        
        if [ "$HEALTH_CHECK_SUCCESS" = false ]; then
          echo "âŒ æ‰€æœ‰å¥åº·æ£€æŸ¥éƒ½å¤±è´¥äº†"
          echo "ğŸ“‹ æœ€ç»ˆå®¹å™¨çŠ¶æ€:"
          $COMPOSE_CMD -f docker-compose.production.yml ps
          echo "ğŸ“‹ åç«¯è¯¦ç»†æ—¥å¿—:"
          $COMPOSE_CMD -f docker-compose.production.yml logs --tail=100 backend
          
          echo "ğŸ” ç½‘ç»œå’Œç«¯å£è¯Šæ–­:"
          netstat -tlnp | grep :8000 || echo "ç«¯å£8000æœªç›‘å¬"
          
          # ä½†ä¸ç«‹å³é€€å‡ºï¼Œç»§ç»­è¿è¡Œè¯Šæ–­
          echo "âš ï¸ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œè¯Šæ–­è„šæœ¬"
        else
          echo "âœ… åç«¯æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
        fi
        fi
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        SCRIPT_EOF
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        scp deploy_script.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "export SERVER_IP=\"$SERVER_IP\" && \
           export SILICONFLOW_API_KEY=\"$SILICONFLOW_API_KEY\" && \
           export JWT_SECRET_KEY=\"$JWT_SECRET_KEY\" && \
           export REDIS_PASSWORD=\"$REDIS_PASSWORD\" && \
           export PERSONAL_ACCESS_TOKEN=\"$PERSONAL_ACCESS_TOKEN\" && \
           export GITHUB_REPOSITORY=\"${{ github.repository }}\" && \
           chmod +x /tmp/deploy_script.sh && \
           bash /tmp/deploy_script.sh"
        
    - name: Wait for services to start
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
    - name: Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:8000/health; then
          echo "âœ… åç«¯APIæ­£å¸¸"
        else
          echo "âŒ åç«¯APIå¼‚å¸¸"
          exit 1
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_IP }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.SERVER_IP }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        fi