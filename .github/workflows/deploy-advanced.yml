name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # æž„å»ºæµ‹è¯•
  build:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install docker-compose
      run: sudo apt-get update && sudo apt-get install -y docker-compose
      
    - name: Create test environment file
      run: |
        cat > .env << EOF
        MONGO_INITDB_ROOT_USERNAME=admin
        MONGO_PASSWORD=Lekairong350702
        REDIS_PASSWORD=Lekairong350702
        SILICONFLOW_API_KEY=sk-test-key
        JWT_SECRET_KEY=test-jwt-secret-key
        DATABASE_SYSTEMHOST=172.16.16.3
        DATABASE_SYSTEM=novel_data
        DATABASE_USER=lkr
        DATABASE_PASSWORD=Lekairong350702
        DATABASE_NOVELHOST=172.16.16.2
        DATABASE_NOVELDATA=novel_user_data
        DATABASE_NOVELUSER=novel_data_user
        DATABASE_NOVELUSER_PASSWORD=Lekairong350702
        SERVER_IP=localhost
        MCP_SERVER_NAME=novel-ai-server
        MCP_SERVER_PORT=8000
        MCP_SERVER_HOST=localhost
        MCP_TOOLS_ENABLED=true
        MCP_TOOLS_LIST=novel_generation,character_creation,plot_analysis,content_review,style_transfer
        NOVEL_GENERATION_MAX_TOKENS=4096
        NOVEL_GENERATION_TEMPERATURE=0.8
        NOVEL_GENERATION_TOP_P=0.9
        SILICONFLOW_DEFAULT_MODEL=deepseek-ai/DeepSeek-V3
        SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
        EOF
      
    - name: Build Docker images
      run: docker-compose build --no-cache
        
    - name: Test Docker containers
      run: |
        echo "ðŸš€ å¯åŠ¨DockeræœåŠ¡..."
        docker-compose up -d
        
        echo "â³ ç­‰å¾…MongoDBå®¹å™¨å¯åŠ¨..."
        sleep 60
        
        echo "ðŸ” æ£€æŸ¥MongoDBå¥åº·çŠ¶æ€..."
        for i in {1..15}; do
          echo "æ£€æŸ¥MongoDBå¥åº·çŠ¶æ€ç¬¬ $i æ¬¡..."
          if docker-compose exec -T mongodb mongosh --quiet --eval "db.adminCommand('ping')" > /dev/null 2>&1; then
            echo "âœ… MongoDBå¥åº·æ£€æŸ¥æˆåŠŸ"
            break
          else
            echo "âŒ MongoDBè¿˜æœªå°±ç»ªï¼Œç­‰å¾…10ç§’åŽé‡è¯•..."
            sleep 10
          fi
          
          if [ $i -eq 15 ]; then
            echo "âŒ MongoDBå¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥"
            echo "MongoDBå®¹å™¨çŠ¶æ€ï¼š"
            docker-compose ps mongodb
            echo "MongoDBå®¹å™¨æ—¥å¿—ï¼š"
            docker-compose logs mongodb --tail=50
            exit 1
          fi
        done
        
        echo "â³ ç­‰å¾…åŽç«¯å®¹å™¨å¯åŠ¨..."
        sleep 45
        
        echo "ðŸ” æ£€æŸ¥å®¹å™¨çŠ¶æ€..."
        docker-compose ps
        
        echo "ðŸ“‹ æ£€æŸ¥MongoDBå®¹å™¨æ—¥å¿—..."
        docker-compose logs mongodb --tail=20
        
        echo "ðŸ“‹ æ£€æŸ¥åŽç«¯å®¹å™¨æ—¥å¿—..."
        docker-compose logs backend --tail=20
        
        echo "ðŸ¥ æ‰§è¡ŒåŽç«¯å¥åº·æ£€æŸ¥..."
        for i in {1..12}; do
          echo "å°è¯•ç¬¬ $i æ¬¡åŽç«¯å¥åº·æ£€æŸ¥..."
          if curl -f http://localhost:8000/health; then
            echo "âœ… åŽç«¯å¥åº·æ£€æŸ¥æˆåŠŸ"
            break
          else
            echo "âŒ åŽç«¯å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…15ç§’åŽé‡è¯•..."
            sleep 15
          fi
          
          if [ $i -eq 10 ]; then
            echo "âŒ åŽç«¯å¥åº·æ£€æŸ¥æœ€ç»ˆå¤±è´¥ï¼Œè¾“å‡ºæ‰€æœ‰å®¹å™¨æ—¥å¿—..."
            docker-compose logs
            exit 1
          fi
        done
        
        echo "ðŸ›‘ åœæ­¢æµ‹è¯•å®¹å™¨..."
        docker-compose down

  # éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ
  deploy:
    needs: [quality-check, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Deploy to production server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
      run: |
        # åˆ›å»ºéƒ¨ç½²è„šæœ¬
        cat > deploy_script.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ å¼€å§‹éƒ¨ç½²AIå°è¯´ç¼–è¾‘å™¨..."
        
        # è®¾ç½®éƒ¨ç½²ç›®å½•
        PROJECT_DIR="/opt/ai-novel-editor"
        BACKUP_DIR="/opt/backups/ai-novel-editor-$(date +%Y%m%d_%H%M%S)"
        
        # åˆ›å»ºç›®å½•
        sudo mkdir -p "$PROJECT_DIR"
        sudo mkdir -p "$(dirname "$BACKUP_DIR")"
        sudo chown $USER:$USER "$PROJECT_DIR"
        sudo chown $USER:$USER "$(dirname "$BACKUP_DIR")"
        
        # å¤‡ä»½çŽ°æœ‰éƒ¨ç½²
        if [ -d "$PROJECT_DIR/.git" ]; then
          echo "ðŸ“¦ å¤‡ä»½çŽ°æœ‰éƒ¨ç½²..."
          cp -r "$PROJECT_DIR" "$BACKUP_DIR"
          echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
        fi
        
        # è¿›å…¥é¡¹ç›®ç›®å½•
        cd "$PROJECT_DIR"
        
        # å…‹éš†æˆ–æ›´æ–°ä»£ç 
        if [ -d ".git" ]; then
          echo "ðŸ“¦ æ›´æ–°ä»£ç ..."
          git fetch origin
          git reset --hard origin/main
          git clean -fd
        else
          echo "ðŸ“¦ å…‹éš†ä»£ç ..."
          git clone https://github.com/$GITHUB_REPOSITORY .
        fi
        
        # åˆ›å»ºçŽ¯å¢ƒå˜é‡æ–‡ä»¶
        echo "ðŸ”§ é…ç½®çŽ¯å¢ƒå˜é‡..."
        cat > .env << EOF
        SERVER_IP=$DEPLOY_HOST
        SERVER_USER=root
        SERVER_SSH_PORT=22
        SERVER_PORT=22
        SILICONFLOW_API_KEY=$SILICONFLOW_API_KEY
        SILICONFLOW_DEFAULT_MODEL=deepseek-ai/DeepSeek-V3
        SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
        MCP_SERVER_NAME=novel-ai-server
        MCP_SERVER_PORT=8000
        MCP_SERVER_HOST=$DEPLOY_HOST
        MCP_TOOLS_ENABLED=true
        MCP_TOOLS_LIST=novel_generation,character_creation,plot_analysis,content_review,style_transfer
        NOVEL_GENERATION_MAX_TOKENS=4096
        NOVEL_GENERATION_TEMPERATURE=0.8
        NOVEL_GENERATION_TOP_P=0.9
        JWT_SECRET_KEY=$JWT_SECRET_KEY
        MONGO_INITDB_ROOT_USERNAME=admin
        MONGO_PASSWORD=$MONGO_PASSWORD
        REDIS_PASSWORD=$REDIS_PASSWORD
        DATABASE_PORT=3306
        DATABASE_SYSTEMHOST=172.16.16.3
        DATABASE_SYSTEM=novel_data
        DATABASE_USER=lkr
        DATABASE_PASSWORD=Lekairong350702
        DATABASE_NOVELHOST=172.16.16.2
        DATABASE_NOVELDATA=novel_user_data
        DATABASE_NOVELUSER=novel_data_user
        DATABASE_NOVELUSER_PASSWORD=Lekairong350702
        DEPLOY_HOST=$DEPLOY_HOST
        EOF
        
        echo "ðŸ” éªŒè¯MongoDBé…ç½®..."
        echo "MONGO_INITDB_ROOT_USERNAME: admin"
        echo "MONGO_PASSWORD: $MONGO_PASSWORD"
        
        # è®¾ç½®è„šæœ¬æƒé™
        chmod +x scripts/*.sh || true
        
        # åœæ­¢çŽ°æœ‰æœåŠ¡
        echo "ðŸ›‘ åœæ­¢çŽ°æœ‰æœåŠ¡..."
        docker-compose down || true
        
        # æ¸…ç†Dockerç¼“å­˜
        echo "ðŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
        docker system prune -f || true
        
        # æž„å»ºå’Œå¯åŠ¨æœåŠ¡
        echo "ðŸ”§ æž„å»ºå’Œå¯åŠ¨æœåŠ¡..."
        docker-compose build --no-cache
        docker-compose up -d
        
        echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        SCRIPT_EOF
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        scp deploy_script.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "export SERVER_IP='$SERVER_IP' && \
           export SILICONFLOW_API_KEY='$SILICONFLOW_API_KEY' && \
           export JWT_SECRET_KEY='$JWT_SECRET_KEY' && \
           export MONGO_PASSWORD='$MONGO_PASSWORD' && \
           export REDIS_PASSWORD='$REDIS_PASSWORD' && \
           export GITHUB_REPOSITORY='${{ github.repository }}' && \
           chmod +x /tmp/deploy_script.sh && \
           bash /tmp/deploy_script.sh"
        
    - name: Wait for services to start
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
    - name: Health check
      run: |
        echo "ðŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥åŽç«¯API
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:8000/health; then
          echo "âœ… åŽç«¯APIæ­£å¸¸"
        else
          echo "âŒ åŽç«¯APIå¼‚å¸¸"
          exit 1
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ðŸŽ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ðŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_IP }}:80"
          echo "ðŸ”§ åŽç«¯API: http://${{ secrets.SERVER_IP }}:8000"
          echo "ðŸ“š APIæ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        fi