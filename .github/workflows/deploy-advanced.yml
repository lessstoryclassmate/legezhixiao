name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout private repository
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.DEPLOY_SSH_KEY }}
        ssh-known-hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        ssh-strict: false
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        echo "ğŸ“¦ å‡†å¤‡å®‰è£…å‰ç«¯ä¾èµ–..."
        echo "=== å½“å‰ç›®å½•å†…å®¹ ==="
        ls -la
        
        echo "=== æ£€æŸ¥ package.json ==="
        if [ -f "package.json" ]; then
          echo "âœ… package.json å­˜åœ¨"
          cat package.json | head -10
        else
          echo "âŒ package.json ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "=== æ£€æŸ¥ package-lock.json ==="
        if [ -f "package-lock.json" ]; then
          echo "âœ… package-lock.json å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < package-lock.json) å­—èŠ‚"
          echo "lockfileVersion: $(grep -o '"lockfileVersion": [0-9]*' package-lock.json | head -1)"
        else
          echo "âŒ package-lock.json ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ npm install"
        fi
        
        echo "=== æ£€æŸ¥ Node.js å’Œ npm ç‰ˆæœ¬ ==="
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        
        echo "ğŸ“¦ å°è¯•ä½¿ç”¨ npm ci å®‰è£…ä¾èµ–..."
        if npm ci --verbose; then
          echo "âœ… npm ci å®‰è£…æˆåŠŸ"
        else
          echo "âŒ npm ci å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm install..."
          echo "=== æ¸…ç†å¯èƒ½çš„æŸåçŠ¶æ€ ==="
          rm -rf node_modules package-lock.json
          echo "=== ä½¿ç”¨ npm install é‡æ–°å®‰è£…å’Œç”Ÿæˆ lock æ–‡ä»¶ ==="
          npm install --verbose
          echo "âœ… npm install å®‰è£…æˆåŠŸ"
        fi
        
        echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
        if [ -d "node_modules" ]; then
          echo "âœ… node_modules ç›®å½•å­˜åœ¨"
          echo "å·²å®‰è£…åŒ…æ•°é‡: $(find node_modules -maxdepth 1 -type d | wc -l)"
        else
          echo "âŒ node_modules ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # é…ç½®éªŒè¯å’ŒåŸºç¡€æµ‹è¯•
  config-validation:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout private repository
      uses: actions/checkout@v4
      with:
        ssh-key: ${{ secrets.DEPLOY_SSH_KEY }}
        ssh-known-hosts: ${{ secrets.SSH_KNOWN_HOSTS }}
        ssh-strict: false
      
    - name: Install docker-compose
      run: sudo apt-get update && sudo apt-get install -y docker-compose
        
    - name: Validate Docker Compose configuration
      run: |
        echo "ğŸ” éªŒè¯ Docker Compose é…ç½®..."
        
        # æ£€æŸ¥å¼€å‘ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… å‘ç°å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶"
          if docker-compose config > /dev/null; then
            echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ å¼€å‘ç¯å¢ƒé…ç½®è¯­æ³•é”™è¯¯"
            exit 1
          fi
        fi
        
        # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.production.yml" ]; then
          echo "âœ… å‘ç°ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶"
          if docker-compose -f docker-compose.production.yml config > /dev/null; then
            echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®è¯­æ³•é”™è¯¯"
            exit 1
          fi
        else
          echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # éªŒè¯ç½‘ç»œé…ç½®
        echo "ğŸ” éªŒè¯ç½‘ç»œé…ç½®..."
        if docker-compose -f docker-compose.production.yml config | grep -A 3 "networks:" | grep -q "app-network"; then
          echo "âœ… å‘ç° app-network é…ç½®"
        else
          echo "âŒ app-network é…ç½®ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate Dockerfiles
      run: |
        echo "ğŸ” éªŒè¯ Dockerfile é…ç½®..."
        
        # æ£€æŸ¥åç«¯ Dockerfile
        if [ -f "backend/Dockerfile" ]; then
          echo "âœ… åç«¯ Dockerfile å­˜åœ¨"
        else
          echo "âŒ åç«¯ Dockerfile ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥å‰ç«¯ Dockerfile
        if [ -f "frontend/Dockerfile" ]; then
          echo "âœ… å‰ç«¯ Dockerfile å­˜åœ¨"
        else
          echo "âŒ å‰ç«¯ Dockerfile ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate deployment scripts
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²è„šæœ¬..."
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶å­˜åœ¨æ€§
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            echo "âœ… å‘ç°è„šæœ¬: $script"
            # æ£€æŸ¥è„šæœ¬è¯­æ³•
            if bash -n "$script"; then
              echo "âœ… è„šæœ¬è¯­æ³•æ­£ç¡®: $script"
            else
              echo "âŒ è„šæœ¬è¯­æ³•é”™è¯¯: $script"
              exit 1
            fi
          fi
        done
        
        echo "âœ… æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: quality-check
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SERVER_IP }}
        username: ${{ secrets.SERVER_USER }}
        key: ${{ secrets.SERVER_SSH_KEY }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² AI å°è¯´ç¼–è¾‘å™¨..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export SERVER_IP="${{ secrets.SERVER_IP }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          export FORCE_LOCAL_DEPLOY=true
          
          # 1. ç«‹å³ä¿®å¤ DNSï¼ˆç¬¬ä¸€ä¼˜å…ˆçº§ï¼‰
          echo "ğŸŒ ç«‹å³ä¿®å¤ DNS é…ç½®..."
          sudo bash -c 'echo -e "nameserver 180.76.76.76\nnameserver 223.5.5.5" > /etc/resolv.conf'
          echo "âœ… DNS å·²è®¾ç½®ä¸ºç™¾åº¦å’Œé˜¿é‡Œäº‘ DNS"
          
          # 2. å½»åº•æ¸…ç† systemd å†²çªï¼ˆç¬¬äºŒä¼˜å…ˆçº§ï¼‰
          echo "ğŸ§¹ å½»åº•æ¸…ç† systemd æœåŠ¡å†²çª..."
          
          # åœæ­¢æ‰€æœ‰å¯èƒ½å†²çªçš„æœåŠ¡
          for service in ai-novel-editor ai-novel-editor.service novel-editor backend frontend; do
            if systemctl list-unit-files | grep -q "^$service"; then
              echo "ğŸ›‘ åœæ­¢æœåŠ¡: $service"
              sudo systemctl stop $service 2>/dev/null || true
              sudo systemctl disable $service 2>/dev/null || true
            fi
            
            # å¼ºåˆ¶åœæ­¢æ­£åœ¨è¿è¡Œçš„æœåŠ¡
            if systemctl is-active --quiet $service 2>/dev/null; then
              echo "ğŸ›‘ å¼ºåˆ¶åœæ­¢: $service"
              sudo systemctl stop $service || true
            fi
            
            # ç§»é™¤æœåŠ¡æ–‡ä»¶
            for path in /etc/systemd/system /lib/systemd/system /usr/lib/systemd/system; do
              if [ -f "$path/$service" ]; then
                echo "ğŸ—‘ï¸ ç§»é™¤: $path/$service"
                sudo rm -f "$path/$service"
              fi
            done
          done
          
          # é‡æ–°åŠ è½½ systemd
          sudo systemctl daemon-reload || true
          sudo systemctl reset-failed || true
          echo "âœ… systemd æ¸…ç†å®Œæˆ"
          
          # 3. éªŒè¯ç½‘ç»œè¿é€šæ€§
          echo "ï¿½ éªŒè¯ç½‘ç»œè¿é€šæ€§..."
          if nslookup github.com > /dev/null 2>&1; then
            echo "âœ… ç½‘ç»œè¿é€šæ€§æ­£å¸¸"
          else
            echo "âŒ ç½‘ç»œè¿é€šæ€§å¼‚å¸¸ï¼Œå°è¯•å…¶ä»– DNS..."
            sudo bash -c 'echo -e "nameserver 8.8.8.8\nnameserver 114.114.114.114" > /etc/resolv.conf'
          fi
          
          # 4. ä¸‹è½½å¹¶æ‰§è¡Œä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬
          echo "ğŸ“¥ ä¸‹è½½ä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬..."
          cd /tmp
          rm -f quick-deploy.sh
          
          if curl -fsSL https://raw.githubusercontent.com/$GITHUB_REPOSITORY/main/scripts/quick-deploy.sh -o quick-deploy.sh; then
            echo "âœ… éƒ¨ç½²è„šæœ¬ä¸‹è½½æˆåŠŸ"
            chmod +x quick-deploy.sh
            
            # æ‰§è¡Œéƒ¨ç½²ï¼ˆå¼ºåˆ¶æœ¬åœ°éƒ¨ç½²æ¨¡å¼ï¼‰
            echo "ğŸš€ æ‰§è¡Œä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬ï¼ˆæœ¬åœ°éƒ¨ç½²æ¨¡å¼ï¼‰..."
            FORCE_LOCAL_DEPLOY=true bash quick-deploy.sh
          else
            echo "âŒ éƒ¨ç½²è„šæœ¬ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          # åœæ­¢æ‰€æœ‰å¯èƒ½å†²çªçš„æœåŠ¡
          for service in ai-novel-editor ai-novel-editor.service novel-editor backend frontend; do
            if systemctl list-unit-files | grep -q "^$service"; then
              echo "ğŸ›‘ åœæ­¢æœåŠ¡: $service"
              sudo systemctl stop $service 2>/dev/null || true
              sudo systemctl disable $service 2>/dev/null || true
            fi
            
            # å¼ºåˆ¶åœæ­¢æ­£åœ¨è¿è¡Œçš„æœåŠ¡
            if systemctl is-active --quiet $service 2>/dev/null; then
              echo "ğŸ›‘ å¼ºåˆ¶åœæ­¢: $service"
              sudo systemctl stop $service || true
            fi
            
            # ç§»é™¤æœåŠ¡æ–‡ä»¶
            for path in /etc/systemd/system /lib/systemd/system /usr/lib/systemd/system; do
              if [ -f "$path/$service" ]; then
                echo "ğŸ—‘ï¸ ç§»é™¤: $path/$service"
                sudo rm -f "$path/$service"
              fi
            done
          done
          
          # é‡æ–°åŠ è½½ systemd
          sudo systemctl daemon-reload || true
          sudo systemctl reset-failed || true
          echo "âœ… systemd æ¸…ç†å®Œæˆ"
          
          # 3. éªŒè¯ç½‘ç»œè¿é€šæ€§
          echo "ğŸ” éªŒè¯ç½‘ç»œè¿é€šæ€§..."
          if nslookup github.com > /dev/null 2>&1; then
            echo "âœ… ç½‘ç»œè¿é€šæ€§æ­£å¸¸"
          else
            echo "âŒ ç½‘ç»œè¿é€šæ€§å¼‚å¸¸ï¼Œå°è¯•å…¶ä»– DNS..."
            sudo bash -c 'echo -e "nameserver 8.8.8.8\nnameserver 114.114.114.114" > /etc/resolv.conf'
          fi
          
          # 4. ä¸‹è½½å¹¶æ‰§è¡Œä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬
          echo "ğŸ“¥ ä¸‹è½½ä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬..."
          cd /tmp
          rm -f quick-deploy.sh
          
          if curl -fsSL https://raw.githubusercontent.com/$GITHUB_REPOSITORY/main/scripts/quick-deploy.sh -o quick-deploy.sh; then
            echo "âœ… éƒ¨ç½²è„šæœ¬ä¸‹è½½æˆåŠŸ"
            chmod +x quick-deploy.sh
            
            # æ‰§è¡Œéƒ¨ç½²
            echo "ğŸš€ æ‰§è¡Œä¿®å¤ç‰ˆéƒ¨ç½²è„šæœ¬..."
            bash quick-deploy.sh
          else
            echo "âŒ éƒ¨ç½²è„šæœ¬ä¸‹è½½å¤±è´¥"
            exit 1
          fi

    - name: Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # ç­‰å¾…æœåŠ¡å¯åŠ¨
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
        # ä¸‹è½½å¥åº·æ£€æŸ¥è„šæœ¬
        cd /tmp
        if curl -fsSL https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/health-check.sh -o health-check.sh; then
          echo "âœ… å¥åº·æ£€æŸ¥è„šæœ¬ä¸‹è½½æˆåŠŸ"
          chmod +x health-check.sh
          
          # æ‰§è¡Œå¥åº·æ£€æŸ¥
          echo "ğŸš€ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          bash health-check.sh
        else
          echo "âŒ å¥åº·æ£€æŸ¥è„šæœ¬ä¸‹è½½å¤±è´¥ï¼Œä½¿ç”¨ç®€å•æ£€æŸ¥"
          
          # ç®€å•å¥åº·æ£€æŸ¥
          echo "ğŸ” ç®€å•å‰ç«¯æ£€æŸ¥..."
          if curl -f --max-time 30 http://localhost:80; then
            echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
          else
            echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
            exit 1
          fi
          
          echo "ğŸ” ç®€å•åç«¯æ£€æŸ¥..."
          if curl -f --max-time 30 http://localhost:8000/health; then
            echo "âœ… åç«¯APIæ­£å¸¸"
          else
            echo "âŒ åç«¯APIå¼‚å¸¸"
            exit 1
          fi
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_IP }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.SERVER_IP }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        fi