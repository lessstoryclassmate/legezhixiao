# GitHub Actions å·¥ä½œæµç¨‹ä¼˜åŒ–ç‰ˆæœ¬

name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        npm ci
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # æ„å»ºæµ‹è¯•
  build:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build Docker images
      run: |
        docker-compose build --no-cache
        
    - name: Test Docker containers
      run: |
        # å¯åŠ¨æœåŠ¡è¿›è¡Œæµ‹è¯•
        docker-compose up -d
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        docker-compose ps
        
        # åŸºç¡€å¥åº·æ£€æŸ¥
        curl -f http://localhost:8000/health || exit 1
        
        # åœæ­¢æµ‹è¯•å®¹å™¨
        docker-compose down

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: [quality-check, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts
        
    - name: Check server connectivity
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} 'echo "Server connected successfully"'
        
    - name: Deploy to production server
      env:
        DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        MONGO_PASSWORD: ${{ secrets.MONGO_PASSWORD }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        MYSQL_HOST: ${{ secrets.MYSQL_HOST }}
        MYSQL_USER: ${{ secrets.MYSQL_USER }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      run: |
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
          set -e
          
          echo "ğŸš€ å¼€å§‹éƒ¨ç½²AIå°è¯´ç¼–è¾‘å™¨..."
          
          # è®¾ç½®éƒ¨ç½²ç›®å½•
          PROJECT_DIR="${{ env.DEPLOY_DIR }}"
          BACKUP_DIR="/opt/backups/ai-novel-editor-$(date +%Y%m%d_%H%M%S)"
          
          # åˆ›å»ºç›®å½•
          sudo mkdir -p "$PROJECT_DIR"
          sudo mkdir -p "$(dirname "$BACKUP_DIR")"
          sudo chown $USER:$USER "$PROJECT_DIR"
          sudo chown $USER:$USER "$(dirname "$BACKUP_DIR")"
          
          # å¤‡ä»½ç°æœ‰éƒ¨ç½²
          if [ -d "$PROJECT_DIR/.git" ]; then
            echo "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²..."
            cp -r "$PROJECT_DIR" "$BACKUP_DIR"
            echo "âœ… å¤‡ä»½å®Œæˆ: $BACKUP_DIR"
          fi
          
          # è¿›å…¥é¡¹ç›®ç›®å½•
          cd "$PROJECT_DIR"
          
          # å…‹éš†æˆ–æ›´æ–°ä»£ç 
          if [ -d ".git" ]; then
            echo "ğŸ“¦ æ›´æ–°ä»£ç ..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          else
            echo "ğŸ“¦ å…‹éš†ä»£ç ..."
            git clone ${{ github.server_url }}/${{ github.repository }}.git .
          fi
          
          # åˆ›å»ºç¯å¢ƒå˜é‡æ–‡ä»¶
          echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
          cat > .env << EOF
          # åº”ç”¨é…ç½®
          APP_NAME=AIå°è¯´å†…å®¹ç¼–è¾‘å™¨
          APP_VERSION=1.0.0
          DEBUG=false
          
          # APIé…ç½®
          SILICONFLOW_API_KEY=${{ secrets.SILICONFLOW_API_KEY }}
          SILICONFLOW_API_URL=https://api.siliconflow.cn/v1
          SILICONFLOW_MODEL=deepseek-v3
          
          # JWTé…ç½®
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          JWT_ALGORITHM=HS256
          JWT_EXPIRE_MINUTES=10080
          
          # æ•°æ®åº“é…ç½®
          MONGODB_URL=mongodb://admin:${{ secrets.MONGO_PASSWORD }}@mongodb:27017/ai_novel_db?authSource=admin
          REDIS_URL=redis://:${{ secrets.REDIS_PASSWORD }}@redis:6379
          MYSQL_HOST=${{ secrets.MYSQL_HOST }}
          MYSQL_PORT=3306
          MYSQL_USER=${{ secrets.MYSQL_USER }}
          MYSQL_PASSWORD=${{ secrets.MYSQL_PASSWORD }}
          MYSQL_DATABASE=ai_novel_cloud
          
          # å¯†ç é…ç½®
          MONGO_PASSWORD=${{ secrets.MONGO_PASSWORD }}
          REDIS_PASSWORD=${{ secrets.REDIS_PASSWORD }}
          
          # CORSé…ç½®
          CORS_ORIGINS=http://${{ secrets.DEPLOY_HOST }}:80,https://${{ secrets.DEPLOY_HOST }}
          EOF
          
          # è®¾ç½®è„šæœ¬æƒé™
          chmod +x scripts/*.sh
          
          # åœæ­¢ç°æœ‰æœåŠ¡
          echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
          docker-compose down || true
          
          # æ¸…ç†Dockerç¼“å­˜
          echo "ğŸ§¹ æ¸…ç†Dockerç¼“å­˜..."
          docker system prune -f || true
          
          # æ„å»ºå’Œå¯åŠ¨æœåŠ¡
          echo "ğŸ”§ æ„å»ºå’Œå¯åŠ¨æœåŠ¡..."
          docker-compose build --no-cache
          docker-compose up -d
          
          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
        '
        
    - name: Wait for services to start
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
    - name: Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.DEPLOY_HOST }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f --max-time 30 http://${{ secrets.DEPLOY_HOST }}:8000/health; then
          echo "âœ… åç«¯APIæ­£å¸¸"
        else
          echo "âŒ åç«¯APIå¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥APIæ–‡æ¡£
        if curl -f --max-time 30 http://${{ secrets.DEPLOY_HOST }}:8000/docs; then
          echo "âœ… APIæ–‡æ¡£æ­£å¸¸"
        else
          echo "âš ï¸ APIæ–‡æ¡£å¯èƒ½å¼‚å¸¸"
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.DEPLOY_HOST }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.DEPLOY_HOST }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.DEPLOY_HOST }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
          echo "è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜"
        fi
        
    - name: Rollback on failure
      if: failure()
      run: |
        echo "ğŸ”„ éƒ¨ç½²å¤±è´¥ï¼Œæ‰§è¡Œå›æ»š..."
        ssh ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} '
          cd ${{ env.DEPLOY_DIR }}
          
          # æŸ¥æ‰¾æœ€æ–°å¤‡ä»½
          LATEST_BACKUP=$(ls -t /opt/backups/ai-novel-editor-* 2>/dev/null | head -1)
          
          if [ -n "$LATEST_BACKUP" ]; then
            echo "ğŸ“¦ å›æ»šåˆ°å¤‡ä»½: $LATEST_BACKUP"
            
            # åœæ­¢å½“å‰æœåŠ¡
            docker-compose down || true
            
            # æ¢å¤å¤‡ä»½
            cp -r "$LATEST_BACKUP"/* .
            
            # é‡å¯æœåŠ¡
            docker-compose up -d
            
            echo "âœ… å›æ»šå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ°å¤‡ä»½æ–‡ä»¶"
          fi
        '

  # éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ
  deploy-dev:
    needs: [quality-check, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    
    steps:
    - name: Deploy to development
      run: |
        echo "ğŸš€ éƒ¨ç½²åˆ°å¼€å‘ç¯å¢ƒ..."
        # è¿™é‡Œå¯ä»¥é…ç½®å¼€å‘ç¯å¢ƒçš„éƒ¨ç½²é€»è¾‘
        echo "âœ… å¼€å‘ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
