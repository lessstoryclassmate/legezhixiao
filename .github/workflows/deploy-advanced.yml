name: Deploy AI Novel Editor

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # ä»£ç è´¨é‡æ£€æŸ¥
  quality-check:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        cd backend
        pip install -r requirements.txt
        
    - name: Run Python linting
      run: |
        cd backend
        python -m flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Install frontend dependencies
      run: |
        cd frontend
        echo "ğŸ“¦ å‡†å¤‡å®‰è£…å‰ç«¯ä¾èµ–..."
        echo "=== å½“å‰ç›®å½•å†…å®¹ ==="
        ls -la
        
        echo "=== æ£€æŸ¥ package.json ==="
        if [ -f "package.json" ]; then
          echo "âœ… package.json å­˜åœ¨"
          cat package.json | head -10
        else
          echo "âŒ package.json ä¸å­˜åœ¨"
          exit 1
        fi
        
        echo "=== æ£€æŸ¥ package-lock.json ==="
        if [ -f "package-lock.json" ]; then
          echo "âœ… package-lock.json å­˜åœ¨"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < package-lock.json) å­—èŠ‚"
          echo "lockfileVersion: $(grep -o '"lockfileVersion": [0-9]*' package-lock.json | head -1)"
        else
          echo "âŒ package-lock.json ä¸å­˜åœ¨ï¼Œå°†ä½¿ç”¨ npm install"
        fi
        
        echo "=== æ£€æŸ¥ Node.js å’Œ npm ç‰ˆæœ¬ ==="
        echo "Node.js: $(node --version)"
        echo "npm: $(npm --version)"
        
        echo "ğŸ“¦ å°è¯•ä½¿ç”¨ npm ci å®‰è£…ä¾èµ–..."
        if npm ci --verbose; then
          echo "âœ… npm ci å®‰è£…æˆåŠŸ"
        else
          echo "âŒ npm ci å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ npm install..."
          echo "=== æ¸…ç†å¯èƒ½çš„æŸåçŠ¶æ€ ==="
          rm -rf node_modules package-lock.json
          echo "=== ä½¿ç”¨ npm install é‡æ–°å®‰è£…å’Œç”Ÿæˆ lock æ–‡ä»¶ ==="
          npm install --verbose
          echo "âœ… npm install å®‰è£…æˆåŠŸ"
        fi
        
        echo "=== éªŒè¯ä¾èµ–å®‰è£… ==="
        if [ -d "node_modules" ]; then
          echo "âœ… node_modules ç›®å½•å­˜åœ¨"
          echo "å·²å®‰è£…åŒ…æ•°é‡: $(find node_modules -maxdepth 1 -type d | wc -l)"
        else
          echo "âŒ node_modules ç›®å½•ä¸å­˜åœ¨"
          exit 1
        fi
        
    - name: Run frontend linting
      run: |
        cd frontend
        npm run lint

  # é…ç½®éªŒè¯å’ŒåŸºç¡€æµ‹è¯•
  config-validation:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install docker-compose
      run: sudo apt-get update && sudo apt-get install -y docker-compose
        
    - name: Validate Docker Compose configuration
      run: |
        echo "ğŸ” éªŒè¯ Docker Compose é…ç½®..."
        
        # æ£€æŸ¥å¼€å‘ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.yml" ]; then
          echo "âœ… å‘ç°å¼€å‘ç¯å¢ƒé…ç½®æ–‡ä»¶"
          if docker-compose config > /dev/null; then
            echo "âœ… å¼€å‘ç¯å¢ƒé…ç½®è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ å¼€å‘ç¯å¢ƒé…ç½®è¯­æ³•é”™è¯¯"
            exit 1
          fi
        fi
        
        # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.production.yml" ]; then
          echo "âœ… å‘ç°ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶"
          if docker-compose -f docker-compose.production.yml config > /dev/null; then
            echo "âœ… ç”Ÿäº§ç¯å¢ƒé…ç½®è¯­æ³•æ­£ç¡®"
          else
            echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®è¯­æ³•é”™è¯¯"
            exit 1
          fi
        else
          echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
        # éªŒè¯ç½‘ç»œé…ç½®
        echo "ğŸ” éªŒè¯ç½‘ç»œé…ç½®..."
        if docker-compose -f docker-compose.production.yml config | grep -A 3 "networks:" | grep -q "app-network"; then
          echo "âœ… å‘ç° app-network é…ç½®"
        else
          echo "âŒ app-network é…ç½®ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate Dockerfiles
      run: |
        echo "ğŸ” éªŒè¯ Dockerfile é…ç½®..."
        
        # æ£€æŸ¥åç«¯ Dockerfile
        if [ -f "backend/Dockerfile" ]; then
          echo "âœ… åç«¯ Dockerfile å­˜åœ¨"
        else
          echo "âŒ åç«¯ Dockerfile ç¼ºå¤±"
          exit 1
        fi
        
        # æ£€æŸ¥å‰ç«¯ Dockerfile
        if [ -f "frontend/Dockerfile" ]; then
          echo "âœ… å‰ç«¯ Dockerfile å­˜åœ¨"
        else
          echo "âŒ å‰ç«¯ Dockerfile ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate deployment scripts
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²è„šæœ¬..."
        
        # æ£€æŸ¥è„šæœ¬æ–‡ä»¶å­˜åœ¨æ€§
        for script in scripts/*.sh; do
          if [ -f "$script" ]; then
            echo "âœ… å‘ç°è„šæœ¬: $script"
            # æ£€æŸ¥è„šæœ¬è¯­æ³•
            if bash -n "$script"; then
              echo "âœ… è„šæœ¬è¯­æ³•æ­£ç¡®: $script"
            else
              echo "âŒ è„šæœ¬è¯­æ³•é”™è¯¯: $script"
              exit 1
            fi
          fi
        done
        
        echo "âœ… æ‰€æœ‰é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²"

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    needs: quality-check
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: ğŸš€ Deploy to Production Server
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ å¼€å§‹éƒ¨ç½² AI å°è¯´ç¼–è¾‘å™¨..."
          
          # è®¾ç½®ç¯å¢ƒå˜é‡
          export SERVER_IP="${{ secrets.HOST }}"
          export GITHUB_REPOSITORY="${{ github.repository }}"
          
          # é¦–å…ˆè¿è¡Œ systemd æ¸…ç†è„šæœ¬
          echo "ğŸ§¹ æ‰§è¡Œ systemd æ¸…ç†..."
          if [ -f "/opt/ai-novel-editor/scripts/cleanup-systemd.sh" ]; then
            sudo bash /opt/ai-novel-editor/scripts/cleanup-systemd.sh || true
          fi
          
          # åˆ›å»ºä¸´æ—¶éƒ¨ç½²è„šæœ¬ï¼ˆé›†æˆDNSä¿®å¤å’Œsystemdæ¸…ç†ï¼‰
          cat > /tmp/deploy.sh << 'EOF'
          #!/bin/bash
          set -e
          
          echo "ğŸš€ å¼€å§‹å¢å¼ºéƒ¨ç½²æµç¨‹..."
          
          # ä¿®å¤ DNSï¼ˆè§£å†³é•œåƒæ‹‰å–å¤±è´¥ï¼‰
          echo "ğŸŒ ä¿®å¤ DNS é…ç½®..."
          sudo bash -c 'echo -e "nameserver 223.5.5.5\nnameserver 180.76.76.76\nnameserver 8.8.8.8" > /etc/resolv.conf'
          
          # éªŒè¯ç½‘ç»œè¿é€šæ€§
          echo "ğŸ” éªŒè¯ç½‘ç»œè¿é€šæ€§..."
          if ! ping -c 2 mirror.baidubce.com > /dev/null 2>&1; then
            echo "âš ï¸ ç™¾åº¦é•œåƒæºç½‘ç»œä¸é€šï¼Œå°è¯•å…¶ä»– DNS..."
            sudo bash -c 'echo -e "nameserver 8.8.8.8\nnameserver 223.5.5.5" > /etc/resolv.conf'
          fi
          
          # å½»åº•æ¸…ç† systemd æœåŠ¡å†²çª
          echo "ğŸ§¹ æ¸…ç† systemd æœåŠ¡å†²çª..."
          for service in ai-novel-editor novel-editor backend frontend; do
            sudo systemctl stop $service 2>/dev/null || true
            sudo systemctl disable $service 2>/dev/null || true
            sudo rm -f /etc/systemd/system/$service.service 2>/dev/null || true
          done
          sudo systemctl daemon-reload || true
          sudo systemctl reset-failed || true
          
          # ä¸‹è½½å¹¶æ‰§è¡Œéƒ¨ç½²è„šæœ¬
          echo "ğŸ“¥ ä¸‹è½½æœ€æ–°éƒ¨ç½²è„šæœ¬..."
          cd /tmp
          rm -f quick-deploy.sh
          curl -fsSL https://raw.githubusercontent.com/$GITHUB_REPOSITORY/main/scripts/quick-deploy.sh -o quick-deploy.sh
          chmod +x quick-deploy.sh
          
          # æ‰§è¡Œéƒ¨ç½²
          echo "ğŸš€ æ‰§è¡Œéƒ¨ç½²..."
          bash quick-deploy.sh
          EOF
          
          chmod +x /tmp/deploy.sh
          bash /tmp/deploy.sh

    - name: Wait for services to start
      run: |
        echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
        sleep 60
        
    - name: Health check
      run: |
        echo "ğŸ” æ‰§è¡Œå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸"
          exit 1
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:8000/health; then
          echo "âœ… åç«¯APIæ­£å¸¸"
        else
          echo "âŒ åç«¯APIå¼‚å¸¸"
          exit 1
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_IP }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.SERVER_IP }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼"
        fi