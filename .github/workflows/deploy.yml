name: Deploy AI Novel Editor (Clone Mode)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # å¿«é€Ÿéƒ¨ç½² (å…‹éš†æ¨¡å¼)
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Deploy to production server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        # ä¸Šä¼ ç®€åŒ–çš„éƒ¨ç½²è„šæœ¬
        scp scripts/quick-deploy.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        
        # æ‰§è¡Œéƒ¨ç½²
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "export SERVER_IP=\"$SERVER_IP\" && \
           export SILICONFLOW_API_KEY=\"$SILICONFLOW_API_KEY\" && \
           export JWT_SECRET_KEY=\"$JWT_SECRET_KEY\" && \
           export REDIS_PASSWORD=\"$REDIS_PASSWORD\" && \
           export PERSONAL_ACCESS_TOKEN=\"$PERSONAL_ACCESS_TOKEN\" && \
           export GITHUB_REPOSITORY=\"${{ github.repository }}\" && \
           chmod +x /tmp/quick-deploy.sh && \
           bash /tmp/quick-deploy.sh"
        
    - name: Health check
      run: |
        echo "ğŸ” å¥åº·æ£€æŸ¥..."
        sleep 60  # ç­‰å¾…æœåŠ¡å¯åŠ¨
        
        # æ£€æŸ¥å‰ç«¯
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:80 > /dev/null 2>&1; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âš ï¸ å‰ç«¯æœåŠ¡æ£€æŸ¥å¤±è´¥"
        fi
        
        # æ£€æŸ¥åç«¯
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:8000/health > /dev/null 2>&1; then
          echo "âœ… åç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âš ï¸ åç«¯æœåŠ¡æ£€æŸ¥å¤±è´¥"
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ å…‹éš†æ¨¡å¼éƒ¨ç½²æˆåŠŸï¼"
          echo ""
          echo "ğŸŒ æœåŠ¡åœ°å€:"
          echo "  å‰ç«¯: http://${{ secrets.SERVER_IP }}:80"
          echo "  åç«¯: http://${{ secrets.SERVER_IP }}:8000"
          echo "  æ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
          echo ""
          echo "âš¡ éƒ¨ç½²æ¨¡å¼: å…‹éš†æ¨¡å¼ (å¿«é€Ÿéƒ¨ç½²)"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼è¯·æ£€æŸ¥æ—¥å¿—"
        fi
