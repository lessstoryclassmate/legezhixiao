name: Deploy AI Novel Editor (Clone Mode)

on:
  push:        # ä¸Šä¼ éƒ¨ç½²ç›¸å…³è„šæœ¬
        scp scripts/quick-deploy.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/network-diagnosis.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/dns-diagnosis.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/dns-fix.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/network-fix-all.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/ci-dns-fix.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/port-conflict-fix.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/

        # é¢„å…ˆæ£€æŸ¥å’Œä¿®å¤ç«¯å£å†²çª
        echo "ğŸšª æ£€æŸ¥å’Œä¿®å¤ç«¯å£å†²çª..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          chmod +x /tmp/port-conflict-fix.sh
          echo 'ğŸ” æ£€æŸ¥80ç«¯å£å†²çª...'
          sudo /tmp/port-conflict-fix.sh --port 80 || echo 'âš ï¸ ç«¯å£80å¤„ç†å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
          echo 'ğŸ” æ£€æŸ¥8000ç«¯å£å†²çª...'
          sudo /tmp/port-conflict-fix.sh --port 8000 || echo 'âš ï¸ ç«¯å£8000å¤„ç†å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
        "

        # é¢„å…ˆä¿®å¤ç½‘ç»œå’ŒDNSé—®é¢˜
        echo "ğŸ”§ é¢„å…ˆä¿®å¤ç½‘ç»œå’ŒDNSé—®é¢˜..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          chmod +x /tmp/network-fix-all.sh /tmp/ci-dns-fix.sh
          echo 'ğŸŒ æ‰§è¡Œç½‘ç»œä¸€é”®ä¿®å¤...'
          sudo /tmp/network-fix-all.sh || echo 'âš ï¸ ç½‘ç»œä¿®å¤å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
          echo 'âš™ï¸ æ‰§è¡ŒCIç¯å¢ƒDNSä¼˜åŒ–...'
          /tmp/ci-dns-fix.sh || echo 'âš ï¸ CI DNSä¼˜åŒ–å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
        "main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # å¿«é€Ÿéƒ¨ç½² (å…‹éš†æ¨¡å¼)
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
    
    - name: Pre-check Docker Hub connectivity
      run: |
        echo "ğŸ” æ£€æŸ¥ Docker Hub è¿æ¥æ€§..."
        if curl -s --connect-timeout 10 https://registry-1.docker.io/v2/ > /dev/null; then
          echo "âœ… Docker Hub å¯è®¿é—®"
          echo "DOCKER_HUB_ACCESSIBLE=true" >> $GITHUB_ENV
        else
          echo "âš ï¸  Docker Hub è®¿é—®å—é™ï¼Œå°†ä½¿ç”¨é»˜è®¤é…ç½®"
          echo "DOCKER_HUB_ACCESSIBLE=false" >> $GITHUB_ENV
        fi
        
        # æ£€æŸ¥å…·ä½“é•œåƒå¯ç”¨æ€§
        echo "ğŸ” æ£€æŸ¥å…³é”®é•œåƒå¯ç”¨æ€§..."
        docker manifest inspect node:18-alpine > /dev/null 2>&1 && echo "âœ… node:18-alpine å¯ç”¨" || echo "âŒ node:18-alpine ä¸å¯ç”¨"
        docker manifest inspect python:3.11-slim > /dev/null 2>&1 && echo "âœ… python:3.11-slim å¯ç”¨" || echo "âŒ python:3.11-slim ä¸å¯ç”¨"
        docker manifest inspect nginx:alpine > /dev/null 2>&1 && echo "âœ… nginx:alpine å¯ç”¨" || echo "âŒ nginx:alpine ä¸å¯ç”¨"
        
    - name: Deploy to production server
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        # ä¸Šä¼ éƒ¨ç½²ç›¸å…³è„šæœ¬
        scp scripts/quick-deploy.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/network-diagnosis.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/dns-diagnosis.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/dns-fix.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/network-fix-all.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/ci-dns-fix.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/port-conflict-fix.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        scp scripts/setup-tencent-docker.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/

        # é…ç½®è…¾è®¯äº‘Dockeré•œåƒåŠ é€Ÿå™¨
        echo "ğŸ³ é…ç½®è…¾è®¯äº‘Dockeré•œåƒåŠ é€Ÿå™¨..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          chmod +x /tmp/setup-tencent-docker.sh
          sudo /tmp/setup-tencent-docker.sh || echo 'âš ï¸ è…¾è®¯äº‘é•œåƒé…ç½®å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
        "

        # é¢„å…ˆæ£€æŸ¥å’Œä¿®å¤ç«¯å£å†²çª
        echo "ğŸšª æ£€æŸ¥å’Œä¿®å¤ç«¯å£å†²çª..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          chmod +x /tmp/port-conflict-fix.sh
          echo 'ğŸ” æ£€æŸ¥80ç«¯å£å†²çª...'
          sudo /tmp/port-conflict-fix.sh --port 80 || echo 'âš ï¸ ç«¯å£80å¤„ç†å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
          echo 'ğŸ” æ£€æŸ¥8000ç«¯å£å†²çª...'
          sudo /tmp/port-conflict-fix.sh --port 8000 || echo 'âš ï¸ ç«¯å£8000å¤„ç†å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
        "

        # é¢„å…ˆä¿®å¤ç½‘ç»œå’ŒDNSé—®é¢˜
        echo "ï¿½ é¢„å…ˆä¿®å¤ç½‘ç»œå’ŒDNSé—®é¢˜..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          chmod +x /tmp/network-fix-all.sh /tmp/ci-dns-fix.sh
          echo 'ğŸŒ æ‰§è¡Œç½‘ç»œä¸€é”®ä¿®å¤...'
          sudo /tmp/network-fix-all.sh || echo 'âš ï¸ ç½‘ç»œä¿®å¤å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
          echo 'âš™ï¸ æ‰§è¡ŒCIç¯å¢ƒDNSä¼˜åŒ–...'
          /tmp/ci-dns-fix.sh || echo 'âš ï¸ CI DNSä¼˜åŒ–å®Œæˆï¼ˆå¯èƒ½æœ‰è­¦å‘Šï¼‰'
        "

        # æ‰§è¡ŒDNSè¯Šæ–­éªŒè¯
        echo "ğŸ” éªŒè¯DNSä¿®å¤ç»“æœ..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "chmod +x /tmp/dns-diagnosis.sh && /tmp/dns-diagnosis.sh" || {
          echo "âš ï¸ DNSéªŒè¯å‘ç°é—®é¢˜ï¼Œè®°å½•ä½†ç»§ç»­éƒ¨ç½²..."
        }

        # æ‰§è¡Œç½‘ç»œè¯Šæ–­
        echo "ğŸ” æ‰§è¡Œç½‘ç»œè¯Šæ–­..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "chmod +x /tmp/network-diagnosis.sh && /tmp/network-diagnosis.sh"

        # æ‰§è¡Œéƒ¨ç½²
        echo "ğŸš€ å¼€å§‹éƒ¨ç½²..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} "
          export SERVER_IP=\"$SERVER_IP\"
          export SILICONFLOW_API_KEY=\"$SILICONFLOW_API_KEY\"
          export JWT_SECRET_KEY=\"$JWT_SECRET_KEY\"
          export REDIS_PASSWORD=\"$REDIS_PASSWORD\"
          export DATABASE_PASSWORD=\"\${DATABASE_PASSWORD:-Lekairong350702}\"
          export DATABASE_NOVELUSER_PASSWORD=\"\${DATABASE_NOVELUSER_PASSWORD:-Lekairong350702}\"
          export GITHUB_REPOSITORY=\"${{ github.repository }}\"
          chmod +x /tmp/quick-deploy.sh
          timeout 1800 /tmp/quick-deploy.sh || {
            echo 'âŒ éƒ¨ç½²è¶…æ—¶æˆ–å¤±è´¥'
            echo 'ğŸ“‹ æ£€æŸ¥ Docker æœåŠ¡çŠ¶æ€:'
            echo 'ğŸ“‹ æ£€æŸ¥å®¹å™¨çŠ¶æ€:'
            sudo docker ps -a || true
            echo 'ğŸ“‹ æ£€æŸ¥ç½‘ç»œè¿æ¥:'
            /tmp/network-diagnosis.sh || true
            tail -50 /var/log/syslog || true
            exit 1
          }
        "

    - name: Verify deployment
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²çŠ¶æ€..."
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "curl -f http://localhost:8000/health && \
           echo 'âœ… åç«¯æœåŠ¡æ­£å¸¸' || echo 'âŒ åç«¯æœåŠ¡å¼‚å¸¸'"
        
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "curl -f http://localhost:80 && \
           echo 'âœ… å‰ç«¯æœåŠ¡æ­£å¸¸' || echo 'âŒ å‰ç«¯æœåŠ¡å¼‚å¸¸'"

  # éƒ¨ç½²çŠ¶æ€é€šçŸ¥ (å¯é€‰)
  notify:
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
    - name: Deployment Status
      run: |
        if [ "${{ needs.deploy.result }}" == "success" ]; then
          echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸ“ è®¿é—®åœ°å€: http://${{ secrets.SERVER_IP }}"
        else
          echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
        fi
