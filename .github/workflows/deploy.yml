name: Deploy AI Novel Editor (Clone Mode)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  PROJECT_NAME: ai-novel-editor
  DEPLOY_DIR: /opt/ai-novel-editor

jobs:
  # å¿«é€Ÿé…ç½®éªŒè¯
  validate-config:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Docker Compose files
      run: |
        echo "ğŸ” éªŒè¯ Docker Compose é…ç½®..."
        
        # æ£€æŸ¥ç”Ÿäº§ç¯å¢ƒé…ç½®
        if [ -f "docker-compose.production.yml" ]; then
          echo "âœ… å‘ç°ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶"
          # åŸºæœ¬è¯­æ³•æ£€æŸ¥ï¼Œä¸éœ€è¦å®Œæ•´éªŒè¯
          if grep -q "version:" docker-compose.production.yml; then
            echo "âœ… é…ç½®æ–‡ä»¶æ ¼å¼æ­£ç¡®"
          else
            echo "âŒ é…ç½®æ–‡ä»¶æ ¼å¼é”™è¯¯"
            exit 1
          fi
        else
          echo "âŒ ç”Ÿäº§ç¯å¢ƒé…ç½®æ–‡ä»¶ç¼ºå¤±"
          exit 1
        fi
        
    - name: Validate deployment scripts
      run: |
        echo "ğŸ” éªŒè¯éƒ¨ç½²è„šæœ¬..."
        
        # æ£€æŸ¥å…³é”®è„šæœ¬æ–‡ä»¶å­˜åœ¨æ€§
        for script in scripts/setup-docker-mirrors.sh scripts/fix-docker-network.sh; do
          if [ -f "$script" ]; then
            echo "âœ… å‘ç°è„šæœ¬: $script"
          else
            echo "âŒ ç¼ºå¤±è„šæœ¬: $script"
            exit 1
          fi
        done
        
        echo "âœ… é…ç½®éªŒè¯é€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œéƒ¨ç½²"

  # å…‹éš†æ¨¡å¼éƒ¨ç½²
  deploy:
    needs: validate-config
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Add server to known hosts
      run: ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts
        
    - name: Deploy to production server (Clone Mode)
      env:
        SERVER_IP: ${{ secrets.SERVER_IP }}
        SILICONFLOW_API_KEY: ${{ secrets.SILICONFLOW_API_KEY }}
        JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
        REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
        PERSONAL_ACCESS_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      run: |
        # åˆ›å»ºç®€åŒ–çš„å…‹éš†æ¨¡å¼éƒ¨ç½²è„šæœ¬
        cat > clone_deploy.sh << 'SCRIPT_EOF'
        #!/bin/bash
        set -e
        
        echo "ğŸš€ å¼€å§‹å…‹éš†æ¨¡å¼éƒ¨ç½²..."
        
        # å¿«é€Ÿæ£€æŸ¥å’Œé…ç½® Docker ç¯å¢ƒ
        echo "ğŸ” æ£€æŸ¥ Docker ç¯å¢ƒ..."
        
        if ! command -v docker &> /dev/null; then
          echo "âŒ Docker æœªå®‰è£…ï¼Œå¼€å§‹å¿«é€Ÿå®‰è£…..."
          curl -fsSL https://get.docker.com | sh
          sudo usermod -aG docker $USER
          sudo systemctl start docker
          sudo systemctl enable docker
        fi
        
        if ! command -v docker-compose &> /dev/null; then
          echo "âŒ Docker Compose æœªå®‰è£…ï¼Œå¼€å§‹å®‰è£…..."
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
        fi
        
        # å¿«é€Ÿé…ç½®é•œåƒåŠ é€Ÿå™¨
        echo "ğŸ”§ å¿«é€Ÿé…ç½®é•œåƒåŠ é€Ÿå™¨..."
        sudo mkdir -p /etc/docker
        sudo tee /etc/docker/daemon.json > /dev/null <<EOF
        {
          "registry-mirrors": [
            "https://registry-1.docker.io",
            "https://docker.mirrors.ustc.edu.cn",
            "https://hub-mirror.c.163.com"
          ],
          "max-concurrent-downloads": 6,
          "log-driver": "json-file",
          "log-opts": {"max-size": "10m", "max-file": "3"}
        }
        EOF
        
        sudo systemctl restart docker
        sleep 10
        
        # è®¾ç½®é¡¹ç›®ç›®å½•
        PROJECT_DIR="/opt/ai-novel-editor"
        sudo mkdir -p "$PROJECT_DIR"
        sudo chown $USER:$USER "$PROJECT_DIR"
        cd "$PROJECT_DIR"
        
        # å…‹éš†æˆ–æ›´æ–°ä»£ç 
        if [ -d ".git" ]; then
          echo "ğŸ“¦ æ›´æ–°ç°æœ‰ä»£ç ..."
          git fetch origin && git reset --hard origin/main
        else
          echo "ğŸ“¦ å…‹éš†ä»£ç ä»“åº“..."
          rm -rf * .*
          git clone https://$PERSONAL_ACCESS_TOKEN@github.com/$GITHUB_REPOSITORY .
        fi
        
        # åˆ›å»ºç¯å¢ƒé…ç½®
        echo "ğŸ”§ é…ç½®ç¯å¢ƒå˜é‡..."
        cat > .env << EOF
        # AI æœåŠ¡é…ç½®
        SILICONFLOW_API_KEY=$SILICONFLOW_API_KEY
        SILICONFLOW_DEFAULT_MODEL=deepseek-ai/DeepSeek-V3
        SILICONFLOW_API_URL=https://api.siliconflow.cn/v1/chat/completions
        JWT_SECRET_KEY=$JWT_SECRET_KEY
        
        # æ•°æ®åº“é…ç½®
        DATABASE_PORT=3306
        DATABASE_SYSTEMHOST=172.16.16.3
        DATABASE_SYSTEM=novel_data
        DATABASE_USER=lkr
        DATABASE_PASSWORD=Lekairong350702
        DATABASE_NOVELHOST=172.16.16.2
        DATABASE_NOVELDATA=novel_user_data
        DATABASE_NOVELUSER=novel_data_user
        DATABASE_NOVELUSER_PASSWORD=Lekairong350702
        
        # Redis é…ç½®
        REDIS_HOST=172.16.32.2
        REDIS_PORT=6379
        REDIS_PASSWORD=$REDIS_PASSWORD
        
        # MongoDB é…ç½®
        MONGODB_HOST=172.16.32.2
        MONGODB_PORT=27017
        MONGODB_DATABASE=ai_novel_db
        EOF
        
        # åœæ­¢ç°æœ‰æœåŠ¡
        echo "ğŸ›‘ åœæ­¢ç°æœ‰æœåŠ¡..."
        docker-compose -f docker-compose.production.yml down --remove-orphans || true
        
        # ä½¿ç”¨å…‹éš†çš„é•œåƒç›´æ¥å¯åŠ¨
        echo "ğŸš€ å¯åŠ¨æœåŠ¡ (å…‹éš†æ¨¡å¼)..."
        
        # å…ˆæ‹‰å–åŸºç¡€é•œåƒ
        echo "ğŸ“¦ æ‹‰å–åŸºç¡€é•œåƒ..."
        docker pull node:18-alpine || echo "è­¦å‘Š: Nodeé•œåƒæ‹‰å–å¤±è´¥"
        docker pull python:3.11-slim || echo "è­¦å‘Š: Pythoné•œåƒæ‹‰å–å¤±è´¥"
        docker pull nginx:alpine || echo "è­¦å‘Š: Nginxé•œåƒæ‹‰å–å¤±è´¥"
        
        # å¯åŠ¨æœåŠ¡ (ä¸æ„å»ºï¼Œç›´æ¥è¿è¡Œ)
        for i in {1..3}; do
          echo "ğŸš€ ç¬¬ $i æ¬¡å¯åŠ¨å°è¯•..."
          
          if docker-compose -f docker-compose.production.yml up -d --build; then
            echo "âœ… å¯åŠ¨æˆåŠŸ"
            break
          else
            echo "âŒ ç¬¬ $i æ¬¡å¯åŠ¨å¤±è´¥"
            if [ $i -lt 3 ]; then
              echo "ç­‰å¾…15ç§’åé‡è¯•..."
              docker-compose -f docker-compose.production.yml down || true
              sleep 15
            fi
          fi
        done
        
        # ç­‰å¾…æœåŠ¡åˆå§‹åŒ–
        echo "â³ ç­‰å¾…æœåŠ¡åˆå§‹åŒ–..."
        sleep 30
        
        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        echo "ğŸ” æ£€æŸ¥æœåŠ¡çŠ¶æ€..."
        docker-compose -f docker-compose.production.yml ps
        
        # ç®€å•å¥åº·æ£€æŸ¥
        echo "ğŸ” å¥åº·æ£€æŸ¥..."
        for i in {1..5}; do
          if curl -f --max-time 10 http://localhost:8000/health 2>/dev/null || curl -f --max-time 10 http://localhost:8000/ 2>/dev/null; then
            echo "âœ… åç«¯æœåŠ¡å¥åº·"
            break
          else
            echo "ç¬¬ $i æ¬¡å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œç­‰å¾…..."
            sleep 10
          fi
        done
        
        echo "âœ… å…‹éš†æ¨¡å¼éƒ¨ç½²å®Œæˆï¼"
        SCRIPT_EOF
        
        # æ‰§è¡Œéƒ¨ç½²è„šæœ¬
        scp clone_deploy.sh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }}:/tmp/
        ssh ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_IP }} \
          "export SERVER_IP=\"$SERVER_IP\" && \
           export SILICONFLOW_API_KEY=\"$SILICONFLOW_API_KEY\" && \
           export JWT_SECRET_KEY=\"$JWT_SECRET_KEY\" && \
           export REDIS_PASSWORD=\"$REDIS_PASSWORD\" && \
           export PERSONAL_ACCESS_TOKEN=\"$PERSONAL_ACCESS_TOKEN\" && \
           export GITHUB_REPOSITORY=\"${{ github.repository }}\" && \
           chmod +x /tmp/clone_deploy.sh && \
           bash /tmp/clone_deploy.sh"
        
    - name: Final health check
      run: |
        echo "ğŸ” æœ€ç»ˆå¥åº·æ£€æŸ¥..."
        
        # æ£€æŸ¥å‰ç«¯æœåŠ¡
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:80; then
          echo "âœ… å‰ç«¯æœåŠ¡æ­£å¸¸"
        else
          echo "âš ï¸ å‰ç«¯æœåŠ¡å¼‚å¸¸"
        fi
        
        # æ£€æŸ¥åç«¯API
        if curl -f --max-time 30 http://${{ secrets.SERVER_IP }}:8000/health; then
          echo "âœ… åç«¯APIæ­£å¸¸"
        else
          echo "âš ï¸ åç«¯APIå¼‚å¸¸"
        fi
        
    - name: Deployment notification
      if: always()
      run: |
        if [ "${{ job.status }}" == "success" ]; then
          echo "ğŸ‰ å…‹éš†æ¨¡å¼éƒ¨ç½²æˆåŠŸï¼"
          echo "ğŸŒ å‰ç«¯åœ°å€: http://${{ secrets.SERVER_IP }}:80"
          echo "ğŸ”§ åç«¯API: http://${{ secrets.SERVER_IP }}:8000"
          echo "ğŸ“š APIæ–‡æ¡£: http://${{ secrets.SERVER_IP }}:8000/docs"
          echo ""
          echo "âš¡ éƒ¨ç½²æ¨¡å¼: å…‹éš†æ¨¡å¼ (æ— æ„å»ºé˜¶æ®µ)"
          echo "â±ï¸ éƒ¨ç½²æ—¶é—´: çº¦ 5-8 åˆ†é’Ÿ"
        else
          echo "âŒ å…‹éš†æ¨¡å¼éƒ¨ç½²å¤±è´¥ï¼"
        fi
