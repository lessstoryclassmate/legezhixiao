# Docker ç½‘ç»œæ¶æ„æ–‡æ¡£

## ç½‘ç»œé…ç½®æ¦‚è§ˆ

### è‡ªå®šä¹‰ç½‘ç»œè®¾è®¡
- **ç½‘ç»œåç§°**: `app-network`
- **ç½‘ç»œç±»å‹**: Bridge ç½‘ç»œ
- **ç½‘ç»œä½œç”¨åŸŸ**: å•ä¸»æœºå®¹å™¨é€šä¿¡
- **è‡ªåŠ¨ DNS**: æ”¯æŒæœåŠ¡åè§£æ

### æœåŠ¡é—´é€šä¿¡æ¨¡å¼

#### å¼€å‘/CI ç¯å¢ƒ (docker-compose.yml)
```yaml
networks:
  app-network:
    driver: bridge
```

æ‰€æœ‰æœåŠ¡è¿æ¥åˆ° `app-network`:
- `frontend` â†” `backend:8000`
- `backend` â†” `mongodb:27017`
- `backend` â†” `redis:6379`

#### ç”Ÿäº§ç¯å¢ƒ (docker-compose.production.yml)
```yaml
networks:
  app-network:
    driver: bridge
```

å®¹å™¨æœåŠ¡ + å¤–éƒ¨æ•°æ®åº“:
- `frontend` â†” `backend:8000` (å®¹å™¨é—´)
- `backend` â†” `172.16.32.2:27017` (MongoDB å¤–éƒ¨æœåŠ¡å™¨)
- `backend` â†” `172.16.32.2:6379` (Redis å¤–éƒ¨æœåŠ¡å™¨)
- `backend` â†” `172.16.16.3:3306` (MySQL ç³»ç»Ÿåº“)
- `backend` â†” `172.16.16.2:3306` (MySQL ç”¨æˆ·åº“)

## ç½‘ç»œè¿é€šæ€§æµ‹è¯•

### CI/CD è‡ªåŠ¨åŒ–æµ‹è¯•
1. **ç½‘ç»œåˆ›å»ºéªŒè¯**: ç¡®ä¿ `app-network` æ­£ç¡®åˆ›å»º
2. **å®¹å™¨è¿æ¥éªŒè¯**: æ£€æŸ¥æ‰€æœ‰æœåŠ¡æ˜¯å¦è¿æ¥åˆ°ç½‘ç»œ
3. **æœåŠ¡å‘ç°æµ‹è¯•**: æµ‹è¯•æœåŠ¡åè§£æ (mongodb, redis)
4. **ç«¯å£è¿é€šæ€§æµ‹è¯•**: éªŒè¯æœåŠ¡é—´ç«¯å£å¯è¾¾æ€§

### è¯Šæ–­è„šæœ¬åŠŸèƒ½
- `scripts/ci-container-diagnostics.sh`: å¼€å‘/CI ç¯å¢ƒç½‘ç»œè¯Šæ–­
- `scripts/production-diagnostics.sh`: ç”Ÿäº§ç¯å¢ƒç½‘ç»œè¯Šæ–­

## æœ€ä½³å®è·µ

### âœ… ä¼˜ç‚¹
1. **ç»Ÿä¸€ç½‘ç»œç®¡ç†**: æ‰€æœ‰æœåŠ¡ä½¿ç”¨åŒä¸€ä¸ªè‡ªå®šä¹‰ç½‘ç»œ
2. **æœåŠ¡å‘ç°**: é€šè¿‡æœåŠ¡åè¿›è¡Œé€šä¿¡ï¼Œæ— éœ€ç¡¬ç¼–ç  IP
3. **ç½‘ç»œéš”ç¦»**: è‡ªå®šä¹‰ç½‘ç»œä¸é»˜è®¤ bridge ç½‘ç»œéš”ç¦»
4. **çµæ´»é…ç½®**: æ”¯æŒå¼€å‘å’Œç”Ÿäº§ç¯å¢ƒä¸åŒçš„ç½‘ç»œé…ç½®

### ğŸ”§ ç½‘ç»œå‘½åè§„èŒƒ
- **ç½‘ç»œåç§°**: `{é¡¹ç›®å}_app-network`
- **å®é™…ç½‘ç»œ**: `legezhixiao_app-network`
- **æœåŠ¡å‘ç°**: ç›´æ¥ä½¿ç”¨æœåŠ¡å (mongodb, redis, backend, frontend)

### ğŸ“Š ç«¯å£æ˜ å°„ç­–ç•¥
```yaml
# å¼€å‘ç¯å¢ƒç«¯å£æ˜ å°„
frontend:
  ports:
    - "80:80"      # HTTP è®¿é—®
    - "8080:80"    # å¤‡ç”¨ç«¯å£
    
backend:
  ports:
    - "8000:8000"  # API æœåŠ¡
    - "3000:8000"  # å¼€å‘ç«¯å£
    
mongodb:
  ports:
    - "27017:27017"  # æ•°æ®åº“è®¿é—®
    
redis:
  ports:
    - "6379:6379"    # ç¼“å­˜è®¿é—®
```

## æ•…éšœæ’é™¤

### å¸¸è§ç½‘ç»œé—®é¢˜
1. **ç½‘ç»œä¸å­˜åœ¨**: æ£€æŸ¥ docker-compose.yml ç½‘ç»œé…ç½®
2. **æœåŠ¡æ— æ³•é€šä¿¡**: éªŒè¯æ‰€æœ‰æœåŠ¡æ˜¯å¦è¿æ¥åˆ° app-network
3. **DNS è§£æå¤±è´¥**: ç¡®ä¿ä½¿ç”¨æ­£ç¡®çš„æœåŠ¡å
4. **ç«¯å£ä¸å¯è¾¾**: æ£€æŸ¥æœåŠ¡å¥åº·çŠ¶æ€å’Œç«¯å£é…ç½®

### è°ƒè¯•å‘½ä»¤
```bash
# æŸ¥çœ‹ç½‘ç»œåˆ—è¡¨
docker network ls

# æ£€æŸ¥ç½‘ç»œè¯¦æƒ…
docker network inspect legezhixiao_app-network

# æµ‹è¯•å®¹å™¨é—´è¿é€šæ€§
docker-compose exec backend ping mongodb
docker-compose exec backend ping redis

# æ£€æŸ¥å®¹å™¨ç½‘ç»œé…ç½®
docker-compose exec backend ip addr show
docker-compose exec backend ip route
```

## ç¯å¢ƒå˜é‡é…ç½®

### å¼€å‘ç¯å¢ƒ
```bash
# ä½¿ç”¨å®¹å™¨æœåŠ¡å
MONGODB_HOST=mongodb
REDIS_HOST=redis
```

### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨å¤–éƒ¨æœåŠ¡å™¨ IP
MONGODB_HOST=172.16.32.2
REDIS_HOST=172.16.32.2
```

## å¥åº·æ£€æŸ¥é›†æˆ

ç½‘ç»œé…ç½®ä¸å¥åº·æ£€æŸ¥é›†æˆï¼Œç¡®ä¿ï¼š
1. æœåŠ¡å¯åŠ¨å‰ç½‘ç»œå°±ç»ª
2. ä¾èµ–æœåŠ¡ç½‘ç»œå¯è¾¾åå†å¯åŠ¨
3. ç½‘ç»œæ•…éšœæ—¶è‡ªåŠ¨é‡å¯

```yaml
backend:
  depends_on:
    mongodb:
      condition: service_healthy
    redis:
      condition: service_healthy
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
```
